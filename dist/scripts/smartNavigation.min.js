class Navigation{static instances=new WeakMap;static getInstance(e){e="string"==typeof e?document.querySelector(e):e;return e instanceof Element?Navigation.instances.get(e):null}static initAll(e,t={}){if("string"!=typeof e)throw new Error("Invalid selector");return Array.from(document.querySelectorAll(e)).map(e=>new Navigation(e,t))}static initOnLoad(e={}){document.addEventListener("DOMContentLoaded",()=>{Navigation.initAll(".navigation",e)})}static destroyAll(){Navigation.instances.forEach(e=>e.destroy())}static sanitizeHTML(e){var t;return"string"!=typeof e?"":((t=document.createElement("div")).textContent=e,t.innerHTML.replace(/(on\w+)=["'][^"']*["']/gi,""))}static isValidUrl(e){if("string"!=typeof e)return!1;if("#"===e)return!0;try{return new URL(e,window.location.origin),!0}catch{return!1}}constructor(e,t={}){if(!(e instanceof Element))throw new Error("Invalid element provided");if(!e.querySelector("ul"))throw new Error("Navigation element must contain a <ul>");if(this.defaults=Object.freeze({accordion:!0,slideUpSpeed:200,slideDownSpeed:200,closedSign:'<i class="sa sa-chevron-down"></i>',openedSign:'<i class="sa sa-chevron-up"></i>',initClass:"js-nav-built",debug:!1,instanceId:"nav-"+this.generateUniqueId(),maxDepth:10,sanitize:!0,animationTiming:"easeOutExpo",debounceTime:0,onError:null,showMore:{enabled:!0,itemsToShow:4,minItemsForToggle:2,moreText:"Show {count} more",lessText:"Show less"}}),this.options=Object.freeze(this.validateOptions({...this.defaults,...t})),this.element=e,this.state=new Proxy({isInitialized:!1,lastInteraction:0,activeSubmenu:null,isAnimating:!1},{set:(e,t,i)=>(e[t]=i,this._debug("State updated: "+t,"info",{value:i}),!0)}),this.cache=new WeakMap,Navigation.instances.has(e))return Navigation.instances.get(e);Navigation.instances.set(e,this),this.handleClick=this.debounce(this.handleClick.bind(this),this.options.debounceTime),this.handleKeydown=this.handleKeydown.bind(this),this.init()}validateOptions(e){var t,i,n={accordion:e=>"boolean"==typeof e,slideUpSpeed:e=>"number"==typeof e&&0<=e&&e<=1e3,slideDownSpeed:e=>"number"==typeof e&&0<=e&&e<=1e3,closedSign:e=>"string"==typeof e&&!/<script/i.test(e),openedSign:e=>"string"==typeof e&&!/<script/i.test(e),initClass:e=>"string"==typeof e,debug:e=>"boolean"==typeof e,maxDepth:e=>"number"==typeof e&&0<e,sanitize:e=>"boolean"==typeof e,animationTiming:e=>"string"==typeof e,debounceTime:e=>"number"==typeof e&&0<=e,onError:e=>"function"==typeof e||null===e};for([t,i]of Object.entries(e))if(t in n&&!n[t](i))throw new TypeError(`Invalid ${t}: `+i);return e}_debug(e,t="log",i={}){var n;this.options.debug&&(n=(new Date).toISOString(),i=JSON.parse(JSON.stringify(i,(e,t)=>"string"==typeof t?Navigation.sanitizeHTML(t):t)),n=`[Navigation ${this.options.instanceId} ${n}]`,({error:console.error,warn:console.warn,info:console.info}[t]||console.log)(n,e,i,"error"===t?(new Error).stack:void 0))}init(){if(this.state.isInitialized)return this._debug("Already initialized","warn");if(!this.element)throw new Error("Navigation element is null");try{this._debug("Initializing navigation","info"),Object.assign(this.element,{role:"navigation",tabIndex:0,"aria-label":"Main navigation"});var e=this.element.querySelector("ul");e&&e.setAttribute("role","menu"),this.element.classList.add(this.options.initClass),this.element.dataset.instanceId=this.options.instanceId,this.setupSecureCache(),this.setupTitleSeparators(),this.setupMenuItems(),this.setupActiveItems(),this.bindSecureEvents(),this.state.isInitialized=!0}catch(e){throw this._debug("Initialization failed","error",{error:e}),this.options.onError?.(e),e}}setupSecureCache(){var e=this.buildCache(this.element);if(!this.validateDOMStructure(e))throw new Error("Invalid DOM structure");this.cache.set(this.element,e)}buildCache(e){const i=[],n=[],s=[],r=(e,t=0)=>{t>this.options.maxDepth||("LI"===e.tagName&&i.push(e),"A"===e.tagName&&n.push(e),"UL"===e.tagName&&s.push(e),Array.from(e.children).forEach(e=>r(e,t+1)))};return r(e),{items:i,links:n,subMenus:s}}validateDOMStructure(e){return e.items.every(e=>this.getElementDepth(e)<=this.options.maxDepth)&&e.links.every(e=>Navigation.isValidUrl(e.getAttribute("href")||"#"))}getElementDepth(e){let t=0,i=e;for(;i&&i!==this.element&&t<=this.options.maxDepth;)t++,i=i.parentElement;return t}setupMenuItems(){var e=this.cache.get(this.element);const u=this.options.showMore;if(u?.enabled){const m=u.itemsToShow||4,p=u.minItemsForToggle||2;e?.items.forEach(e=>{if(e.classList.contains("nav-title"))t=e.querySelector("span")?.textContent||"Section",e.setAttribute("role","separator"),e.setAttribute("aria-label",t);else{const a=e.querySelector("ul");if(a&&this.getElementDepth(a)<=this.options.maxDepth){e.classList.add("has-ul"),Object.assign(a,{role:"menu","data-depth":this.getElementDepth(a),style:{display:"none"}});var t=Array.from(a.children),i=t.filter(e=>!e.querySelector("ul")),t=t.filter(e=>e.querySelector("ul")),n=i.slice(0,m),i=i.slice(m),s=i.length;if(s>=p){const o=document.createElement("div");o.className="nav-hidden-container";var r=i.some(e=>e.classList.contains("active")),n=(r?(o.style.display="flex",o.style.height="auto"):(o.style.display="none",o.style.height="0"),o.style.overflow="hidden",a.innerHTML="",n.forEach(e=>a.appendChild(e)),t.forEach(e=>a.appendChild(e)),i.forEach(e=>o.appendChild(e)),a.appendChild(o),document.createElement("li"));n.className="nav-show-more",n.setAttribute("role","presentation");const l=document.createElement("a"),h=(l.href="#",l.className="nav-more-link",l.setAttribute("role","button"),l.setAttribute("aria-expanded",r?"true":"false"),l.setAttribute("aria-controls","nav-toggle-"+this.generateUniqueId().substring(0,8)),document.createElement("span")),c=u.moreText.replace("{count}",s);h.textContent=r?u.lessText:c,l.appendChild(h);t=document.createElement("span");t.className="collapse-sign",t.setAttribute("aria-hidden","true");const d=document.createElement("i");d.className=r?"sa sa-chevron-up":"sa sa-chevron-down",t.appendChild(d),l.appendChild(t),r&&l.classList.add("showing-more"),n.appendChild(l),a.appendChild(n);i=l.getAttribute("aria-controls");o.id=i,l.addEventListener("click",e=>{e.preventDefault(),l.classList.contains("showing-more")?this.animateHeight(o,"up",()=>{o.style.display="none",h.textContent=c,l.classList.remove("showing-more"),l.setAttribute("aria-expanded","false"),d.className="sa sa-chevron-down"}):(o.style.display="flex",this.animateHeight(o,"down",()=>{h.textContent=u.lessText,l.classList.add("showing-more"),l.setAttribute("aria-expanded","true"),d.className="sa sa-chevron-up"}))})}s=e.querySelector("a:first-child");s&&this.setupSecureLink(s)}e.classList.contains("nav-title")||(e.role="menuitem")}})}}setupSecureLink(e){var t=document.createElement("span"),i=(t.className="collapse-sign",t.setAttribute("aria-hidden","true"),document.createElement("i")),i=(i.className="sa sa-chevron-down",t.appendChild(i),e.closest("li"));i&&(i.setAttribute("aria-expanded","false"),i.setAttribute("aria-haspopup","true")),"#"===e.getAttribute("href")&&e.addEventListener("click",e=>e.preventDefault()),e.appendChild(t)}setupActiveItems(){this.cache.get(this.element)?.items.forEach(t=>{if(t.classList.contains("active")){let e=t.parentElement;for(;e&&e!==this.element;){var i;"UL"===e.tagName&&(e.style.display="flex",e.style.height="auto",i=e.parentElement)&&"LI"===i.tagName&&(i.classList.add("open","has-ul"),i.setAttribute("aria-expanded","true"),i.setAttribute("aria-haspopup","true"),i=i.querySelector("a"))&&(i=i.querySelector(".collapse-sign i"))&&(i.className="sa sa-chevron-up"),e=e.parentElement}var n,s=t.querySelector("ul");s?(s.style.display="flex",s.style.height="auto",t.classList.add("open","has-ul"),t.setAttribute("aria-expanded","true"),t.setAttribute("aria-haspopup","true"),(n=t.querySelector("a"))&&(n=n.querySelector(".collapse-sign i"))&&(n.className="sa sa-chevron-up"),this.state.activeSubmenu=s):t.setAttribute("aria-current","page")}})}bindSecureEvents(){this.element.removeEventListener("mousedown",this.handleClick),this.element.removeEventListener("keydown",this.handleKeydown),this.element.addEventListener("mousedown",this.handleClick,{passive:!0}),this.element.addEventListener("keydown",this.handleKeydown)}handleClick(e){var t,i,n=e.target.closest("a");n&&this.element.contains(n)&&(i=(t=n.parentElement).querySelector("ul"))&&(e.preventDefault(),this.toggleSubmenu(t,n,i))}handleKeydown(e){var t=e.target.closest("a");if(t&&this.element.contains(t))switch(e.key){case"Enter":case" ":e.preventDefault(),this.handleClick(e);break;case"Escape":e.preventDefault(),this.closeAllSubmenus(),t.focus();break;case"ArrowDown":case"ArrowUp":e.preventDefault(),this.navigateMenu(t,"ArrowDown"===e.key?"next":"prev")}}toggleSubmenu(e,t,i){if(this.state.isAnimating)this._debug("Animation in progress, ignoring toggle request");else{var n="true"===e.getAttribute("aria-expanded");this.options.accordion&&this.handleAccordion(e);const s=t.querySelector(".collapse-sign i");this.state.isAnimating=!0,n?(i.style.display="flex",this.animateHeight(i,"up",()=>{e.classList.remove("open"),e.setAttribute("aria-expanded","false"),s&&(s.className="sa sa-chevron-down"),this.state.activeSubmenu=null,this.state.isAnimating=!1})):(i.style.display="flex",this.animateHeight(i,"down",()=>{e.classList.add("open"),e.setAttribute("aria-expanded","true"),s&&(s.className="sa sa-chevron-up"),this.state.activeSubmenu=i,this.state.isAnimating=!1}))}}animateHeight(e,t,i){var n=e._transitionEndListener,n=(n&&e.removeEventListener("transitionend",n),"up"===t?this.options.slideUpSpeed:this.options.slideDownSpeed),s="easeOutExpo"===this.options.animationTiming?"cubic-bezier(0.16, 1, 0.3, 1)":this.options.animationTiming;if(e.style.removeProperty("transition"),e.style.removeProperty("height"),e.style.removeProperty("overflow"),"down"===t){e.style.display="flex",e.style.overflow="hidden",e.style.height="0",e.offsetHeight;t=e.scrollHeight;e.style.transition=`height ${n}ms `+s,e.style.height=t+"px";const r=()=>{e.removeEventListener("transitionend",r),e._transitionEndListener=null,e.style.removeProperty("height"),e.style.removeProperty("overflow"),e.style.removeProperty("transition"),i()};e._transitionEndListener=r,e.addEventListener("transitionend",r,{once:!0})}else{e.style.overflow="hidden",e.style.height=e.scrollHeight+"px",e.offsetHeight,e.style.transition=`height ${n}ms `+s,e.style.height="0";const a=()=>{e.removeEventListener("transitionend",a),e._transitionEndListener=null,e.style.display="none",e.style.removeProperty("height"),e.style.removeProperty("overflow"),e.style.removeProperty("transition"),i()};e._transitionEndListener=a,e.addEventListener("transitionend",a,{once:!0})}}handleAccordion(n){Array.from(n.parentElement.children).forEach(t=>{if(t!==n){var e=t.querySelector("ul");const i=t.querySelector("a");e&&"none"!==getComputedStyle(e).display&&this.animateHeight(e,"up",()=>{t.classList.remove("open"),t.setAttribute("aria-expanded","false");var e=i?.querySelector(".collapse-sign i");e&&(e.className="sa sa-chevron-down")})}})}navigateMenu(e,t){var i=Array.from(this.element.querySelectorAll("li a")),e=i.indexOf(e);i["next"===t?(e+1)%i.length:(e-1+i.length)%i.length].focus()}closeAllSubmenus(){this.cache.get(this.element)?.subMenus.forEach(e=>{if("none"!==e.style.display){const t=e.parentElement;this.animateHeight(e,"up",()=>{t.classList.remove("open"),t.setAttribute("aria-expanded","false");var e=t.querySelector("a");e&&(e=e.querySelector(".collapse-sign i"))&&(e.className="sa sa-chevron-down")})}}),this.state.activeSubmenu=null}toggleAll(s=!0){this.cache.get(this.element)?.items.forEach(e=>{var t,i=e.querySelector("ul"),n=e.querySelector("a");i&&n&&(t="true"===e.getAttribute("aria-expanded"),s&&!t||!s&&t)&&this.toggleSubmenu(e,n,i)})}focusItem(e){if(!e||!this.element.contains(e))throw new Error("Invalid item");e.querySelector("a")?.focus()}debounce(t,i){let n;return(...e)=>{clearTimeout(n),n=setTimeout(()=>t(...e),i)}}destroy(){if(!this.state.isInitialized)return this._debug("Cannot destroy - not initialized","warn");try{this._debug("Starting destruction","info"),this.element.removeEventListener("click",this.handleClick),this.element.removeEventListener("keydown",this.handleKeydown),this.resetItems(),this.cleanLinks(),this.resetSubmenus(),this.element.removeAttribute("role"),this.element.removeAttribute("tabIndex"),this.element.removeAttribute("aria-label"),this.element.removeAttribute("data-instance-id"),this.element.classList.remove(this.options.initClass),this.cache.delete(this.element),Navigation.instances.delete(this.element),this.state.isInitialized=!1,this._debug("Navigation destroyed","info")}catch(e){throw this._debug("Destruction failed","error",{error:e}),this.options.onError?.(e),e}}resetItems(){this.cache.get(this.element)?.items.forEach(e=>{e.classList.remove("active","open"),e.removeAttribute("role")})}cleanLinks(){this.cache.get(this.element)?.links.forEach(e=>{var t=e.cloneNode(!0);e.parentNode?.replaceChild(t,e),t.classList.remove("active"),t.querySelector(".collapse-sign")?.remove()})}resetSubmenus(){this.cache.get(this.element)?.subMenus.forEach(e=>{e.removeAttribute("style"),e.removeAttribute("role")})}createMenuItem(e){if(!e||"object"!=typeof e)throw new Error("Invalid configuration");var{text:e,url:t="#",parent:i=null,hasSubmenu:n=!1}=e;if(!e||"string"!=typeof e)throw new Error("Text is required");if(!Navigation.isValidUrl(t))throw new Error("Invalid URL");try{var s=document.createElement("li"),r=(s.setAttribute("role","menuitem"),document.createElement("a"));if(r.href=this.options.sanitize?Navigation.sanitizeHTML(t):t,r.textContent=this.options.sanitize?Navigation.sanitizeHTML(e):e,n){var a=document.createElement("ul");if(a.style.display="none",a.setAttribute("role","menu"),a.dataset.depth=i?parseInt(i.querySelector("ul")?.dataset.depth||0)+1:1,a.dataset.depth>this.options.maxDepth)throw new Error("Maximum nesting depth exceeded");this.setupSecureLink(r),s.appendChild(r),s.appendChild(a)}else s.appendChild(r);var o=i?i.querySelector("ul"):this.element;if(o)return o.appendChild(s),this.setupSecureCache(),s;throw new Error("Invalid parent")}catch(e){throw this._debug("Failed to create menu item","error",{error:e}),this.options.onError?.(e),e}}removeMenuItem(e){if(!e||!this.element.contains(e))throw new Error("Invalid item");try{e.remove(),this.setupSecureCache(),this._debug("Menu item removed","info")}catch(e){throw this._debug("Failed to remove item","error",{error:e}),this.options.onError?.(e),e}}updateMenuItem(e,t){if(!e||!this.element.contains(e))throw new Error("Invalid item");if(!t||"object"!=typeof t)throw new Error("Invalid config");try{var i=e.querySelector("a");if(!i)throw new Error("Link not found");if(t.text&&(i.textContent=this.options.sanitize?Navigation.sanitizeHTML(t.text):t.text),t.url){if(!Navigation.isValidUrl(t.url))throw new Error("Invalid URL");i.href=this.options.sanitize?Navigation.sanitizeHTML(t.url):t.url}var n=i.querySelector(".collapse-sign");n&&i.appendChild(n),this._debug("Menu item updated","info")}catch(e){throw this._debug("Failed to update item","error",{error:e}),this.options.onError?.(e),e}}moveMenuItem(e,t=null){if(!e||!this.element.contains(e))throw new Error("Invalid item");t=t?t.querySelector("ul"):this.element;if(!t)throw new Error("Invalid parent");try{if(this.getElementDepth(t)+1>this.options.maxDepth)throw new Error("Maximum nesting depth exceeded");t.appendChild(e),this.setupSecureCache(),this._debug("Menu item moved","info")}catch(e){throw this._debug("Failed to move item","error",{error:e}),this.options.onError?.(e),e}}generateUniqueId(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}setupTitleSeparators(){this.element.querySelectorAll("li.nav-title").forEach(e=>{var t=e.querySelector("span")?.textContent||"Section";e.setAttribute("role","separator"),e.setAttribute("aria-label",t),e.removeAttribute("role"),e.setAttribute("role","separator")})}}