class SmartTables{constructor(e,t){this.defaults={perPage:10,search:!0,sort:!0,pagination:!0,export:!1,import:!1,print:!1,addRecord:!1,deleteRecord:!1,editRecord:!1,loading:{enabled:!0,duration:0,minDuration:300},responsive:{enabled:!1,breakpoint:768,columnPriorities:{0:1,1:2,2:3,3:4,4:5,5:6},details:{type:"column",target:0}},debug:!1,fuzzyMatch:{threshold:0,minMatchLength:3,multiWordThreshold:0,maxDistance:1},classes:{wrapper:"st-wrapper",table:"st-table table table-striped table-hover",toolbar:"st-toolbar d-flex justify-content-between mb-3",search:"st-search form-control",pagination:"st-pagination pagination justify-content-center",export:"st-export btn-group"},data:{type:null,source:null,columns:[],processing:!1,serverSide:!1,method:"GET",headers:{},params:{},parser:null,cacheDuration:3e5,prefetch:!0},hooks:{beforeInit:null,afterInit:null,beforeDestroy:null,afterDestroy:null,beforeDataLoad:null,afterDataLoad:null,beforeDraw:null,afterDraw:null,beforeEdit:null,beforeEdit:null,afterEdit:null,afterEdit:null,beforeSave:null,afterSave:null,onSort:null,onFilter:null,onPaginate:null,onExport:null,onImport:null,onResize:null,onExpandedRowInit:null,beforeDelete:null,afterDelete:null,onEditModalCreated:null,onEditModalBeforeShow:null,onEditModalAfterShow:null,onEditCancelled:null,onEditDataCollected:null,beforeApplyEdit:null,onProcessEditData:null,onEditSuccess:null,onEditError:null,onDeleteModalCreated:null,onDeleteModalBeforeShow:null,onDeleteModalAfterShow:null,onDeleteCancelled:null,beforeProcessDelete:null,onDeleteSuccess:null,onDeleteError:null,onDeleteFetchOptions:null,onEditFetchOptions:null,beforeAddRecord:null,afterAddRecord:null,onAddModalCreated:null,onAddModalBeforeShow:null,onAddModalAfterShow:null,onAddCancelled:null,onAddDataCollected:null,beforeAddRecordSave:null,onAddRecordSuccess:null,onAddRecordError:null,onAddRequestOptions:null},plugins:[]},"boolean"==typeof t.responsive&&(t.responsive={enabled:t.responsive}),this.options={...this.defaults,...t},Array.isArray(this.options.data.columns)||(this.options.data.columns=[]),this.table="string"==typeof e?document.getElementById(e):e,(this.table.__smartTable=this).currentPage=1,this.rows=[],this.filteredRows=[],this.hiddenColumns=[],this.columnWidths=[],this.plugins=[],this.responsiveColumns=[],this.ajaxCache=new Map,this.searchQuery="",this.currentSortColumn=void 0,this.currentSortDirection=null,this.totalRows=0,this.isLoadingAjax=!1,this.isTableInitialized=!1,this.hasDNoneBeenRemoved=!1,this.serverSideHandleSearch=function(e){var t;this.searchQuery=e,this.options.loading.enabled&&(this.wrapper.classList.add("st-loading"),this.wrapper.classList.add("st-ajax-loading"),this.wrapper.querySelector(".st-loading-spinner")||((t=document.createElement("div")).className="st-loading-spinner",this.wrapper.appendChild(t))),this.currentPage=1,this.loadAjax(),this.callHook("onFilter",e,null)},this.debouncedServerSideHandleSearch=SmartTables.debounce(this.serverSideHandleSearch.bind(this),300),this.debouncedLoadAjax=SmartTables.debounce(this.loadAjax.bind(this),250),this.lastRequestTime=0,this.handleSearch=function(e){this.log("SmartTables search initiated with value:",e),!0===this.options.data.serverSide?(this.log("Using server-side search implementation"),this.debouncedServerSideHandleSearch(e)):(this.log("Using client-side search with fuzzy matching"),SmartTables.prototype.handleSearch.call(this,e))}.bind(this),this.abortController=null,this.log("Final options after constructor:",this.options),this.log("cacheDuration after constructor:",this.options.data.cacheDuration),this.log("prefetch setting after constructor:",this.options.data.prefetch),this.init()}static extend(a,...e){return e.forEach(t=>{t&&Object.keys(t).forEach(e=>{t.hasOwnProperty(e)&&(a[e]=t[e])})}),a}static debounce(a,s){let o;return function(...e){const t=this;clearTimeout(o),o=setTimeout(()=>a.apply(t,e),s)}}static createNode(e){var t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}init(){var e;return this.callHook("beforeInit"),void 0===this.options.data.prefetch&&(this.options.data.prefetch=!0,this.log("🔄 INIT: Setting prefetch to true because it was undefined")),this.setupWrapper(),!1===this.options.hoverRows&&this.table.classList.add("table-hover-disable"),this.options.loading.enabled&&(this.wrapper.classList.add("st-loading"),(e=document.createElement("div")).className="st-loading-spinner",this.wrapper.appendChild(e)),this.loadDataSource(),this.currentPage=1,this.initializePlugins(),this.callHook("afterInit"),this}loadDataSource(){if(!this.options.data.type&&this.table&&this.table.querySelector("tbody")&&this.table.querySelector("tbody tr"))this.processExistingTableData();else switch(this.options.data.type){case"json":this.loadJSON();break;case"csv":this.loadCSV();break;case"ajax":this.loadAjax();break;case"txt":this.loadTXT();break;case"excel":this.loadExcel();break;default:console.error("SmartTables: Invalid data source type")}}loadJSON(){const t=this;"string"==typeof this.options.data.source?fetch(this.options.data.source).then(e=>e.json()).then(e=>t.processData(e)).catch(e=>{console.error("SmartTables: Error loading JSON:",e),t.hideLoading()}):"object"==typeof this.options.data.source&&this.processData(this.options.data.source)}loadCSV(){const t=this;"string"==typeof this.options.data.source&&(this.options.data.source.startsWith("data:")?this.parseCSV(this.options.data.source):fetch(this.options.data.source).then(e=>e.text()).then(e=>t.parseCSV(e)).catch(e=>{console.error("SmartTables: Error loading CSV:",e),t.hideLoading()}))}loadAjax(){const t=this,a=(this.log("loadAjax called - prefetch setting:",this.options.data.prefetch,"current page:",this.currentPage,"search query:",this.searchQuery),this.generateCacheKey());if(this.ajaxCache.has(a)){var e=this.ajaxCache.get(a),s=Date.now()-e.timestamp,o=this.options.data.cacheDuration||3e5;if(this.log("📦 CACHE HIT: Age (ms):",s,"Cache duration (ms):",o,"For page:",this.currentPage,"Search:",this.searchQuery),s<o)return this.log("📦 CACHE HIT: Using cached data for key:",a,"For page:",this.currentPage,"Search:",this.searchQuery),this.options.data.serverSide?(this.totalRows=e.total,this.processData(e.data),this.log("📦 CACHE HIT: Pagination handler will trigger prefetch if needed")):this.processData(e.data),void this.hideLoading();this.log("Cache expired for key:",a,"Age:",s,"Duration:",o,"For page:",this.currentPage,"Search:",this.searchQuery),this.ajaxCache.delete(a)}else this.log("🔍 CACHE MISS - No cache entry found for key:",a,"For page:",this.currentPage,"Search:",this.searchQuery),this.log("Existing cache keys:",Array.from(this.ajaxCache.keys()));this.isLoadingAjax&&(this.log("loadAjax already in progress, aborting previous request and starting new one"),this.abortController)&&this.abortController.abort(),this.isLoadingAjax=!0,this.abortController=new AbortController,this.options.loading.enabled&&(this.wrapper.classList.add("st-ajax-loading"),this.wrapper.classList.add("st-loading"),this.wrapper.querySelector(".st-loading-spinner")||((e=document.createElement("div")).className="st-loading-spinner",this.wrapper.appendChild(e)));s={method:this.options.data.method||"GET",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...this.options.data.headers},signal:this.abortController.signal};let i=this.options.data.source;const r={...this.options.data.params};if(this.options.data.serverSide&&(r.page=parseInt(this.currentPage,10)||1,r.perPage=parseInt(this.options.perPage,10)||10,r.search=this.searchQuery||"",void 0!==this.currentSortColumn&&(r.sortColumn=this.currentSortColumn),this.currentSortDirection&&(r.sortDirection=this.currentSortDirection),r.fields=Array.isArray(this.options.data.columns)?this.options.data.columns.map(e=>e.data).join(","):"",this.log("Server-side params:",r)),"GET"===s.method&&0<Object.keys(r).length){const n=new URLSearchParams;Object.keys(r).forEach(e=>{null!==r[e]&&void 0!==r[e]&&n.append(e,r[e])}),i+=(i.includes("?")?"&":"?")+n.toString(),this.log("AJAX URL with params:",i)}else"POST"===s.method&&(s.body=JSON.stringify(r));this.callHook("beforeDataLoad",i,s);o=fetch(i,s).then(e=>{if(!e.ok)throw new Error("HTTP error! Status: "+e.status);var t=e.headers.get("Content-Type");if(t&&t.includes("application/json"))return e.json();throw new Error("Server response is not JSON")}).then(e=>{if(t.options.data.serverSide){if(!e||void 0===e.data||!Array.isArray(e.data))throw new Error('Server-side response must include a "data" array property');t.totalRows=e.total||e.data.length,t.log("Server returned",e.data.length,"rows, total:",t.totalRows),t.lastSearchQuery=t.searchQuery,t.ajaxCache.set(a,{data:e.data,total:e.total,timestamp:Date.now(),search:t.searchQuery}),t.log("Cached response for key:",a),0===t.totalRows&&t.searchQuery?(t.showNoResultsMessage(t.searchQuery),t.tableBody&&(t.tableBody.innerHTML="")):t.removeNoResultsMessage(),t.processData(e.data),t.options.data.prefetch&&t.currentPage<Math.ceil(t.totalRows/t.options.perPage)?(t.log("Initiating prefetch for next page - current page:",t.currentPage,"total pages:",Math.ceil(t.totalRows/t.options.perPage),"prefetch enabled:",!!t.options.data.prefetch,"search query:",t.searchQuery),t.prefetchNextPage()):t.log("Not prefetching next page - current page:",t.currentPage,"total pages:",Math.ceil(t.totalRows/t.options.perPage),"prefetch enabled:",!!t.options.data.prefetch,"search query:",t.searchQuery)}else{if(!Array.isArray(e))throw new Error("Client-side response must be an array");t.ajaxCache.set(a,{data:e,timestamp:Date.now(),search:t.searchQuery}),t.log("Cached response for key:",a),t.processData(e)}t.callHook("afterDataLoad",e)}).catch(e=>{"AbortError"===e.name?t.log("Request aborted - user initiated a new request"):(console.error("SmartTables: Error loading data:",e),t.showNotification("Error loading data: "+e.message,"danger"),t.hideLoading())}).finally(()=>{!t.abortController||t.abortController.signal.aborted?t.log("Not clearing loading state - request was aborted or is no longer current"):(t.log("Request complete - clearing loading state"),t.hideLoading(),t.abortController=null,t.isLoadingAjax=!1)}),e=new Promise((e,t)=>setTimeout(()=>t(new Error("Request timed out")),3e4));Promise.race([o,e]).catch(e=>{"Request timed out"===e.message&&(t.abortController&&!t.abortController.signal.aborted?(console.error("SmartTables: Request timeout"),t.showNotification("Request timed out. Please try again.","danger"),t.hideLoading(),t.abortController=null,t.isLoadingAjax=!1):t.log("Timed out request was for an old request, ignoring"))})}prefetchNextPage(){const t=this.currentPage+1;var e=Math.ceil(this.totalRows/this.options.perPage);if(this.log("🔮 PREFETCH: Checking next page",t,"of",e,"total. Search:",this.searchQuery),t>e)this.log("🔮 PREFETCH: Skipping prefetch - next page",t,"exceeds total pages",e,"Search:",this.searchQuery);else{var e=this.currentPage;this.currentPage=t;const a=this.generateCacheKey();this.currentPage=e,this.ajaxCache.has(a)?this.log("🔮 PREFETCH: Next page already cached, skipping prefetch:",t,"Search:",this.searchQuery):(this.log("🔮 PREFETCH: Starting prefetch for page",t,"with cache key:",a,"Search:",this.searchQuery),e={...this.options.data.params,page:t,perPage:this.options.perPage,search:this.searchQuery||"",sortColumn:void 0!==this.currentSortColumn?this.currentSortColumn:"",sortDirection:this.currentSortDirection||"",fields:Array.isArray(this.options.data.columns)?this.options.data.columns.map(e=>e.data).join(","):""},e=this.options.data.source+(0<Object.keys(e).length?(this.options.data.source.includes("?")?"&":"?")+new URLSearchParams(e).toString():""),this.log("🔮 PREFETCH: URL for next page:",e),fetch(e,{method:this.options.data.method||"GET",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...this.options.data.headers}}).then(e=>{if(e.ok)return e.json();throw new Error("HTTP error! Status: "+e.status)}).then(e=>{if(!Array.isArray(e.data))throw new Error('Server response "data" must be an array');e.total!==this.totalRows&&this.log("🔮 PREFETCH: Warning - total rows changed from",this.totalRows,"to",e.total,"during prefetch"),this.ajaxCache.set(a,{data:e.data,total:e.total,timestamp:Date.now(),search:this.searchQuery}),this.log("🔮 PREFETCH: Successfully cached data for page",t,"with key:",a,"Search:",this.searchQuery),this.log("🔮 PREFETCH: Current cache size:",this.ajaxCache.size,"entries")}).catch(e=>{this.log("🔮 PREFETCH: Failed for page:",t,"Error:",e,"Search:",this.searchQuery)}))}}generateCacheKey(){var e={url:this.options.data.source,page:this.currentPage,perPage:this.options.perPage,search:(this.searchQuery||"").trim().toLowerCase(),sortColumn:void 0!==this.currentSortColumn?this.currentSortColumn:"",sortDirection:this.currentSortDirection||""},t=JSON.stringify(e);return this.log("🔑 Generated cache key:",{page:this.currentPage,search:e.search,key:t}),t}clearAjaxCache(){this.ajaxCache.clear()}parseCSV(e){try{var t=e.split(/\r\n|\n/);if(!t.length)throw new Error("No data found in CSV");var a=t[0],s=this.parseCSVLine(a),o=[];for(let e=1;e<t.length;e++)if(""!==t[e].trim()){var i=this.parseCSVLine(t[e]);if(i.length<s.length)console.warn("SmartTables: Line "+e+" has fewer values than headers, skipping");else{var r={};for(let e=0;e<s.length;e++)r[s[e]]=i[e];o.push(r)}}return o}catch(e){throw console.error("CSV parsing error:",e),new Error("Failed to parse CSV: "+e.message)}}parseCSVLine(t){var a=[];let s=!1,o="";for(let e=0;e<t.length;e++){var i=t[e];'"'!==i||0!==e&&"\\"===t[e-1]?","!==i||s?o+=i:(a.push(o.trim().replace(/^"(.*)"$/,"$1")),o=""):s=!s}return a.push(o.trim().replace(/^"(.*)"$/,"$1")),a}processData(l){this.log(`Processing ${l.length} rows of data`),this.options.data.serverSide&&0===l.length&&this.searchQuery?this.showNoResultsMessage(this.searchQuery):0<l.length&&this.removeNoResultsMessage();performance.now(),l.length;requestAnimationFrame(()=>{try{if(this.options.data.parser&&(l=this.options.data.parser(l)),Array.isArray(l)||(console.error("SmartTables: Data must be an array of objects"),this.showNotification("Invalid data format. Expected an array of objects.","danger"),l=[]),this.log("Processing data",{count:l.length,currentPage:this.currentPage,serverSide:this.options.data.serverSide}),this.options.data.columns&&0!==this.options.data.columns.length||(this.options.data.columns=this.detectColumns(l)),this.options.data.serverSide&&this.table&&this.table.querySelector("tbody")&&this.isTableInitialized){this.log("Updating table with new server-side data for page",this.currentPage);const s=this.currentSortColumn,o=this.currentSortDirection,i=this.hiddenColumns?[...this.hiddenColumns]:[],r=(this.log("Stored current hidden columns before update:",i),e=>{const t=Math.min(e+100,l.length);var a=l.slice(e,t);this.updateTableData(a,0===e),t<l.length?requestAnimationFrame(()=>r(t)):(this.rows=Array.from(this.table.querySelector("tbody").rows).map((e,t)=>({element:e,expanded:!1,originalIndex:t})),0<i.length&&(this.hiddenColumns=i,this.log("Restored hidden columns before draw:",this.hiddenColumns)),this.options.responsive&&this.options.responsive.enabled&&(this.log("Reapplying responsive setup for server-side data"),this.setupResponsiveRows(),this.checkResponsiveDisplay()),this.draw(),void 0!==s&&(this.log("Reapplying sort column class after data update for column "+s),(a=this.table.querySelectorAll("thead th")).length>s&&(Array.from(a).forEach(e=>{e.classList.remove("st-sort-asc","st-sort-desc")}),a[s].classList.add("asc"===o?"st-sort-asc":"st-sort-desc")),this.addSortColumnClass(s)))});void r(0)}else{var e,t,a;this.table?((e=this.table.querySelector("tbody"))?e.innerHTML="":(e=document.createElement("tbody"),this.table.appendChild(e)),(t=this.table.querySelector("thead"))?(t.innerHTML="",a=document.createElement("tr"),this.options.data.columns.forEach(function(e){var t=document.createElement("th");t.textContent=e.title||e.data,e.width&&(t.style.width=e.width),e.class&&(t.className=e.class),a.appendChild(t)}),t.appendChild(a)):(t=document.createElement("thead"),a=document.createElement("tr"),this.options.data.columns.forEach(function(e){var t=document.createElement("th");t.textContent=e.title||e.data,e.width&&(t.style.width=e.width),e.class&&(t.className=e.class),a.appendChild(t)}),t.appendChild(a),this.table.insertBefore(t,e))):this.createTableFromData(l);const n=e=>{const t=Math.min(e+100,l.length);var a=l.slice(e,t);this.updateTableData(a,0===e),t<l.length?requestAnimationFrame(()=>n(t)):this.finalizeDataProcessing()};n(0)}}catch(e){console.error("Error processing data:",e),this.showNotification("Error processing data: "+e.message,"danger"),this.hideLoading()}})}processExistingTableData(){try{var e=this.table.querySelector("thead");let s=[];e&&(s=Array.from(e.querySelectorAll("th")).map(e=>({title:e.textContent.trim(),data:e.textContent.trim().toLowerCase().replace(/\s+/g,"_")})));var t=this.table.querySelector("tbody"),a=Array.from(t.querySelectorAll("tr")).map(e=>{e=Array.from(e.cells);const a={};return e.forEach((e,t)=>{t=s[t]||{data:"column_"+t,title:"Column "+(t+1)};a[t.data]=e.textContent.trim()}),a});0===s.length&&0<a.length&&(s=Object.keys(a[0]).map(e=>({data:e,title:e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}))),this.options.data.columns=s,this.processData(a)}catch(e){console.error("SmartTables: Error processing existing table data:",e),this.showNotification("Error processing table data: "+e.message,"danger"),this.hideLoading()}}createTableFromData(e){this.table=document.createElement("table"),this.wrapper.appendChild(this.table);var t=document.createElement("thead"),a=document.createElement("tr"),t=(this.options.data.columns.forEach(function(e){var t=document.createElement("th");t.textContent=e.title||e.data,e.width&&(t.style.width=e.width),e.class&&(t.className=e.class),a.appendChild(t)}),t.appendChild(a),this.table.appendChild(t),document.createElement("tbody"));this.table.appendChild(t)}updateTableData(e,t=!0){try{var a=this.hiddenColumns?[...this.hiddenColumns]:[],s=(this.log("Stored current hidden columns before update:",a),this.searchQuery),o=(this.log("Stored current search query before update:",s),this.table.querySelector("tbody"));t&&(o.innerHTML="",this.options.data.serverSide)&&(this.filteredRows=[]);const i=document.createDocumentFragment();e.forEach((a,e)=>{var s=document.createElement("tr");s.setAttribute("data-id",a.id),this.options.data.columns.forEach(function(e){var t=document.createElement("td");e.render?t.innerHTML=e.render(a[e.data],a):t.textContent=a[e.data]||"",t.classList.remove("st-sort-column"),e.class&&(t.className=e.class),s.appendChild(t)},this),i.appendChild(s),this.options.data.serverSide&&(e=(this.currentPage-1)*this.options.perPage+e,this.filteredRows[e]={element:s,expanded:!1,data:a,index:e},this.log("Stored row data for index:",e))},this),o.appendChild(i),t&&(this.rows=Array.from(o.rows).map((e,t)=>({element:e,expanded:!1,originalIndex:t})),this.options.data.serverSide||(this.filteredRows=this.rows.slice()),void 0!==this.currentSortColumn&&this.currentSortDirection&&(this.log("Reapplying sort column class after data update for column "+this.currentSortColumn),this.addSortColumnClass(this.currentSortColumn)),this.options.responsive&&this.options.responsive.enabled&&(this.calculateColumnWidths(),a&&0<a.length?(this.log("Reapplying hidden columns after data update:",a),a.forEach(e=>{this.hideColumn(e)})):this.checkResponsiveDisplay(),this.updateExpandedRowsAfterResize()),this.searchQuery=s,this.log("Restored search query after data update:",this.searchQuery),this.searchQuery)&&""!==this.searchQuery.trim()&&(this.log("Reapplying search after data update with query:",this.searchQuery),this.options.data.serverSide||setTimeout(()=>{this.handleSearch(this.searchQuery)},50))}catch(e){console.error("Error updating table data:",e),this.showNotification("Error updating table: "+e.message,"danger")}}finalizeDataProcessing(){var e;this.isTableInitialized?(this.options.data.serverSide&&this.options.responsive.enabled&&(this.log("Ensuring responsive calculations are applied for server-side data"),e=this.wrapper.getBoundingClientRect().width,this.lastWrapperWidth&&this.lastWrapperWidth===e||(this.lastWrapperWidth=e,this.calculateColumnWidths())),this.draw()):(this.initializeTable(),this.isTableInitialized=!0),this.hideLoading()}hideLoading(){var e;this.options.loading.enabled&&(this.log("🔄 LOADING: Hiding all loading indicators"),this.wrapper.classList.remove("st-loading"),this.wrapper.classList.remove("st-ajax-loading"),(e=this.wrapper.querySelector(".st-loading-spinner"))&&(e.remove(),this.log("🔄 LOADING: Removed spinner element")),this.table&&(this.table.classList.contains("d-none")||(this.table.style.opacity="1",this.log("🔄 LOADING: Set table opacity to 1")),this.table.classList.contains("d-none"))&&this.isTableInitialized&&!this.hasDNoneBeenRemoved&&setTimeout(()=>{this.table.classList.remove("d-none"),this.table.style.opacity="1",this.hasDNoneBeenRemoved=!0,this.log("🔄 LOADING: Removed d-none class from table and set opacity to 1")},100),this.isLoadingAjax=!1,this.abortController)&&(this.log("🔄 LOADING: Clearing abort controller"),this.abortController=null)}setupWrapper(){this.wrapper=document.createElement("div"),this.wrapper.className=this.options.classes.wrapper,this.wrapper.style.position="relative",this.wrapper.style.width="100%",this.table.parentNode.insertBefore(this.wrapper,this.table),this.wrapper.appendChild(this.table),this.table.className=this.options.classes.table,this.table.style.width="100%"}initializeTable(){try{this.setupToolbar(),this.setupTable();var t=this.table.querySelector("tbody");this.originalRows=Array.from(t.rows),this.rows=Array.from(t.rows).map(function(e,t){return{element:e,expanded:!1,originalIndex:t}}),this.filteredRows=this.rows.slice(),this.table.classList.contains("d-none")||(this.table.style.opacity="0.01"),requestAnimationFrame(()=>{this.calculateColumnWidths(),this.isTableInitialized=!0,this.draw(),this.options.loading.enabled&&setTimeout(()=>{this.wrapper.classList.remove("st-loading"),this.table.classList.contains("d-none")||(this.table.style.opacity="1");var e=this.wrapper.querySelector(".st-loading-spinner");e&&e.remove(),this.isImportOperation&&(this.showNotification("Successfully imported "+this.rows.length+" rows","success"),this.isImportOperation=!1)},this.options.loading.duration||300)})}catch(e){console.error("Error initializing table:",e),this.options.loading.enabled&&(this.wrapper.classList.remove("st-loading"),this.table.classList.contains("d-none")||(this.table.style.opacity="1"),t=this.wrapper.querySelector(".st-loading-spinner"))&&t.remove()}this.callHook("afterInit")}calculateColumnWidths(){var i=this;if(Array.isArray(this.responsiveColumns)&&0!==this.responsiveColumns.length){for(var e=this.wrapper.getBoundingClientRect().width,r=(this.log("Container width:",e),this.table.cloneNode(!0)),t=(r.style.width="auto",r.style.tableLayout="auto",r.style.position="absolute",r.style.top="-9999px",r.style.left="-9999px",r.style.visibility="hidden",r.querySelectorAll('th[style*="display: none"], td[style*="display: none"]')),a=0;a<t.length;a++)t[a].style.display="";document.body.appendChild(r);let o=0;this.responsiveColumns.forEach(function(e){for(var t=r.querySelector("thead th:nth-child("+(e.index+1)+")"),a=(e.minWidth=t?t.offsetWidth:0,r.querySelectorAll("tbody tr")),s=0;s<a.length;s++)a[s]&&a[s].cells[e.index]&&(e.minWidth=Math.max(e.minWidth,a[s].cells[e.index].offsetWidth));e.minWidth+=5,o+=e.minWidth,i.log("Column",e.index,"min width:",e.minWidth)}),document.body.removeChild(r),this.containerWidth=e,this.log("Stored container width:",this.containerWidth),this.log("Total columns width needed:",o),this.applyResponsiveDisplay(e,o)}else this.log("Skipping column width calculation: responsiveColumns not populated")}applyResponsiveDisplay(t,a){if(t<a){this.log("Applying responsive column visibility");var o=[...this.responsiveColumns].sort((e,t)=>t.priority-e.priority);let e=a,s=[];for(const i of o){if(e<=t)break;s.push(i.index),e-=i.minWidth,this.log("Hiding column",i.index,"to save",i.minWidth,"px")}this.responsiveColumns.forEach(e=>{var t=this.table.querySelectorAll(`tr > *:nth-child(${e.index+1})`);const a=s.includes(e.index);t.forEach(e=>{e.style.display=a?"none":""})})}else this.log("Showing all columns"),this.responsiveColumns.forEach(e=>{this.table.querySelectorAll(`tr > *:nth-child(${e.index+1})`).forEach(e=>{e.style.display=""})});this.options.contentObserver&&setTimeout(()=>{this.setupContentObservers()},0)}setupToolbar(){this.toolbar=document.createElement("div"),this.toolbar.className="st-toolbar row mb-4";var s,e,t,a,o,i=document.createElement("div"),r=(i.className="col-12 col-sm-6 col-lg-6 col-xl-5 col-xxl-4 order-1 order-sm-0 mt-4 mt-sm-0",this.options.search&&((e=document.createElement("div")).className="st-search-wrapper",(t=document.createElement("div")).className="input-group flex-nowrap",t.setAttribute("role","search"),(r=document.createElement("span")).className="input-group-text px-2",r.id="search-icon",r.innerHTML='<svg class="sa-icon sa-bold"><use href="img/sprite.svg#search"></use></svg>',(a=document.createElement("input")).type="text",a.className="form-control",a.id="addon-wrapping-left",a.placeholder="Search...",a.setAttribute("aria-label","Search input"),a.setAttribute("aria-describedby","search-icon"),a.setAttribute("autocomplete","off"),t.appendChild(r),t.appendChild(a),e.appendChild(t),s=this,a.addEventListener("input",function(){s.handleSearch(this.value)}),i.appendChild(e)),document.createElement("div"));r.className="col d-flex justify-content-end gap-2",this.options.print&&((t=document.createElement("button")).className="btn btn-sm btn-outline-secondary btn-icon h-100 order-1 px-3 fs-xl",t.type="button",t.innerHTML='<i class="sa sa-printer"></i>',t.addEventListener("click",()=>{this.printTable()}),r.appendChild(t)),this.options.import&&((a=document.createElement("button")).className="btn btn-sm btn-outline-success d-flex align-items-center gap-1",a.setAttribute("data-bs-toggle","modal"),a.setAttribute("data-bs-target","#importModal"),a.type="button",a.innerHTML='<i class="sa sa-cloud-upload"></i> Import',r.appendChild(a),this.createImportModal()),this.options.addRecord&&((e=document.createElement("button")).className="btn btn-sm btn-outline-success d-flex align-items-center gap-1",e.id="st-add-record-btn",e.type="button",e.innerHTML="Add Record",e.addEventListener("click",()=>{this.addRecord()}),r.appendChild(e)),this.options.export&&((t=document.createElement("div")).className="btn-group",(a=document.createElement("button")).className="btn btn-sm btn-outline-primary dropdown-toggle",a.type="button",a.setAttribute("data-bs-toggle","dropdown"),a.textContent="Export",(o=document.createElement("ul")).className="dropdown-menu",[{format:"excel",label:"Excel"},{format:"csv",label:"CSV"},{format:"copy",label:"Copy"},{format:"pdf",label:"PDF"},{format:"json",label:"JSON"},{format:"xml",label:"XML"},{format:"html",label:"HTML"}].forEach(function(t){var e=document.createElement("li"),a=document.createElement("a");a.className="dropdown-item",a.href="#",a.textContent=t.label,a.addEventListener("click",function(e){e.preventDefault(),s.exportData(t.format)}),e.appendChild(a),o.appendChild(e)}),t.appendChild(a),t.appendChild(o),r.appendChild(t)),this.toolbar.appendChild(i),this.toolbar.appendChild(r),this.wrapper.insertBefore(this.toolbar,this.table)}createImportModal(){var e,t,a,s,o,i,r,n,l,d,c,h=this,p="importModal";function u(s){o.className="alert alert-info mb-3",o.textContent="Reading file...",d.disabled=!0;var e=new FileReader,t=(e.onload=function(e){try{var t=s.name.toLowerCase(),a=30<s.name.length?s.name.substring(0,27)+"...":s.name;if(t.endsWith(".json"))try{c=JSON.parse(e.target.result),o.className="alert alert-success mb-3",o.innerHTML="JSON file <b>"+a+"</b> loaded successfully. Ready to import.",d.disabled=!1}catch(e){o.className="alert alert-danger mb-3",o.innerHTML="Invalid JSON format in file <b>"+a+"</b>: "+e.message}else if(t.endsWith(".csv"))try{c=h.parseCSV(e.target.result),o.className="alert alert-success mb-3",o.innerHTML="CSV file <b>"+a+"</b> loaded successfully. Ready to import.",d.disabled=!1}catch(e){o.className="alert alert-danger mb-3",o.innerHTML="Invalid CSV format in file <b>"+a+"</b>: "+e.message}else o.className="alert alert-danger mb-3",o.innerHTML="Unsupported file format: <b>"+a+"</b>. Please use CSV or JSON."}catch(e){o.className="alert alert-danger mb-3",o.innerHTML="Error processing file <b>"+s.name+"</b>: "+e.message}},e.onerror=function(){o.className="alert alert-danger mb-3",o.innerHTML="Error reading file <b>"+s.name+"</b>."},s.name.toLowerCase());t.endsWith(".json")||t.endsWith(".csv")?e.readAsText(s):(o.className="alert alert-danger mb-3",o.innerHTML="Unsupported file format: <b>"+s.name+"</b>. Please use CSV or JSON.")}document.getElementById(p)||((e=document.createElement("div")).className="modal fade",e.id=p,e.tabIndex=-1,e.setAttribute("aria-labelledby","importModalLabel"),e.setAttribute("aria-hidden","true"),(p=document.createElement("div")).className="modal-dialog modal-dialog-centered",(t=document.createElement("div")).className="modal-content",(a=document.createElement("div")).className="modal-header",(s=document.createElement("h5")).className="modal-title",s.id="importModalLabel",s.textContent="Import Data",(n=document.createElement("button")).type="button",n.className="btn btn-system ms-auto",n.setAttribute("data-bs-dismiss","modal"),n.setAttribute("aria-label","Close"),n.innerHTML='<svg class="sa-icon sa-icon-2x"><use href="img/sprite.svg#x"></use></svg>',a.appendChild(s),a.appendChild(n),(s=document.createElement("div")).className="modal-body",(o=document.createElement("div")).className="alert d-none mb-3",s.appendChild(o),(i=document.createElement("div")).className="st-dropzone p-5 text-center d-flex flex-column align-items-center border border-2 border-dashed rounded bg-faded",i.innerHTML='<svg class="sa-icon sa-icon-success sa-thin sa-icon-5x mb-2"><use href="img/sprite.svg#upload-cloud"></use></svg><p>Drag and drop your CSV or JSON file here<br>or <b class="text-primary fw-500 cursor-pointer">click to browse</b></p>',(r=document.createElement("input")).type="file",r.className="visually-hidden",r.accept=".csv,.json",i.appendChild(r),s.appendChild(i),(n=document.createElement("div")).className="modal-footer",(l=document.createElement("button")).type="button",l.className="btn btn-danger",l.setAttribute("data-bs-dismiss","modal"),l.textContent="Cancel",(d=document.createElement("button")).type="button",d.className="btn btn-success",d.textContent="Import",d.disabled=!0,n.appendChild(l),n.appendChild(d),t.appendChild(a),t.appendChild(s),t.appendChild(n),p.appendChild(t),e.appendChild(p),document.body.appendChild(e),i.addEventListener("click",function(){r.click()}),i.addEventListener("dragover",function(e){e.preventDefault(),i.classList.add("border-primary")}),i.addEventListener("dragleave",function(){i.classList.remove("border-primary")}),i.addEventListener("drop",function(e){e.preventDefault(),i.classList.remove("border-primary"),e.dataTransfer.files.length&&u(e.dataTransfer.files[0])}),r.addEventListener("change",function(){this.files.length&&u(this.files[0])}),e.addEventListener("show.bs.modal",function(){o.className="alert d-none mb-3",o.textContent="",d.disabled=!0,r.value=""}),c=null,d.addEventListener("click",function(){c&&(h.importData(c),bootstrap.Modal.getInstance(e).hide())}))}importData(t){try{if(this.isImportOperation=!0,this.callHook("beforeDataLoad",t),this.options.loading.enabled&&(this.wrapper.classList.add("st-loading"),this.wrapper.querySelector(".st-loading-spinner")||((s=document.createElement("div")).className="st-loading-spinner",this.wrapper.appendChild(s))),this.destroy(),this.isTableInitialized=!1,this.options.data.columns=null,!t)throw new Error("No data provided for import");if(!Array.isArray(t))throw new Error("Data must be an array of objects");if(0===t.length)throw new Error("Data array is empty");this.options.data.columns=this.detectColumns(t),this.table||(this.table=document.createElement("table"),this.table.className=this.options.classes.table,this.wrapper.appendChild(this.table)),this.rows=[],this.filteredRows=[],this.originalRows=[],this.options.data.serverSide=!1,void 0===this.options.data.prefetch&&(this.options.data.prefetch=!0,this.log("🔄 IMPORT: Setting prefetch to true because it was undefined")),this.processData(t),setTimeout(()=>{this.hideLoading()},500),this.table.querySelectorAll("th").forEach(function(e){e.classList.remove("st-sort-asc","st-sort-desc"),e.classList.add("st-sort-neutral"),e.removeAttribute("data-sort-state")}),this.callHook("onImport",t)}catch(e){console.error("Import error:",e),this.hideLoading(),this.showNotification("Import failed: "+e.message,"danger"),this.table&&this.table.remove();var a=document.createElement("div"),s=(a.className="alert alert-danger mt-3",""),t=document.querySelector(".modal .alert.alert-success"),o=(t&&(t=t.innerHTML.match(/<b>(.*?)<\/b>/))&&t[1]&&(s=t[1]),a.innerHTML=s?'<h4 class="alert-heading">Import Failed</h4><p>Failed to import <b>'+s+'</b></p><hr><p class="mb-0">Error: '+e.message+"</p>":'<h4 class="alert-heading">Import Failed</h4><p>Error: '+e.message+"</p>",this.wrapper.appendChild(a),document.createElement("button"));o.className="btn btn-primary mt-3",o.innerHTML='<i class="sa sa-refresh"></i> Try Again',o.addEventListener("click",function(){var e=document.getElementById("importModal");e&&new bootstrap.Modal(e).show(),a.remove(),o.remove(),this.table=document.createElement("table"),this.table.className=this.options.classes.table,this.wrapper.appendChild(this.table),this.processData([])}.bind(this)),this.wrapper.appendChild(o)}}detectColumns(e){var a;return e&&e.length?(e=e[0],a=[],Object.keys(e).forEach(function(e){let t=e;0<t.length&&(t=t.charAt(0).toUpperCase()+t.slice(1)),/^[A-Z]+$/.test(t)||(t=t.replace(/([a-z])([A-Z])/g,"$1 $2")),a.push({data:e,title:t})}),a):[]}setupTable(){var s,o=this;this.options.responsive.enabled&&this.table.classList.add("st-responsive"),this.options.sort&&(s=this.table.querySelectorAll("thead th")).forEach(function(a,e){var t;"false"!==a.getAttribute("data-sortable")&&(a.classList.add("st-sort-neutral"),a.style.cursor="pointer",a._sortHandler=t=function(){s.forEach(function(e,t){e!==a&&(e.classList.remove("st-sort-asc","st-sort-desc"),e.classList.add("st-sort-neutral"),e.removeAttribute("data-sort-state"),Array.from(o.table.querySelectorAll("tbody tr")).forEach(function(e){e.cells[t]&&e.cells[t].classList.remove("st-sort-column")}))}),a.hasAttribute("data-sort-state")?"asc"===a.getAttribute("data-sort-state")?(a.setAttribute("data-sort-state","desc"),a.classList.remove("st-sort-asc"),a.classList.add("st-sort-desc"),o.addSortColumnClass(e)):(a.removeAttribute("data-sort-state"),a.classList.remove("st-sort-desc"),a.classList.add("st-sort-neutral"),o.removeSortColumnClass(e)):(a.setAttribute("data-sort-state","asc"),a.classList.remove("st-sort-neutral"),a.classList.add("st-sort-asc"),o.addSortColumnClass(e)),o.sortBy(e,a.getAttribute("data-sort-state"))},a.addEventListener("click",t))}),this.options.responsive.enabled&&this.setupResponsiveRows(),this.options.responsive.enabled&&this.setupResponsive()}handleSearch(e){var i,r,n;this.searchQuery=e,this.options.data.serverSide?(this.currentPage=1,this.log("Initiating server-side search for:",e),this.loadAjax(),this.callHook("onFilter",e,null)):((i=e.toLowerCase().trim())?(r={isDate:/^\d{1,4}[-/.]?\d{1,2}[-/.]?\d{1,4}$/.test(i),isMoney:/^\$?\d+(?:,\d{3})*(?:\.\d{1,2})?$/.test(i),isPhone:this.extractPhoneNumber(i),isEmail:/@/.test(i),isNumeric:/^[<>]=?|=|!=?\s*\d+(?:\.\d+)?$/.test(i),isTime:/^([0-1][0-9]|2[0-3]):[0-5][0-9](:[0-5][0-9])?$/.test(i),isURL:/^(https?:\/\/)?([\w.-]+)\.([a-z]{2,})(\/\S*)?$/.test(i),isIP:/^(\d{1,3}\.){3}\d{1,3}$/.test(i),isUUID:/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(i),isBoolean:/^(true|false|yes|no|1|0)$/i.test(i),isHexColor:/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(i),isAlphanumeric:/^[a-zA-Z0-9\s-]+$/.test(i),isSocialSecurity:/^\d{3}-\d{2}-\d{4}$/.test(i)},n=this.parseNumericComparison(i),this.removeNoResultsMessage(),this.filteredRows=this.rows.filter(function(e){return Array.from(e.element.cells).some(function(e){var t=e.textContent.toLowerCase(),e=e.innerHTML.toLowerCase();if(t.includes(i))return!0;if(this.fuzzyMatch(t,i))return!0;if(r.isDate){var a=this.parseDate(t),s=this.parseDate(i);if(a&&s)return a.getTime()===s.getTime()}if(r.isMoney){var a=parseFloat(i.replace(/[$,]/g,"")),s=parseFloat(t.replace(/[$,]/g,""));if(!isNaN(a)&&!isNaN(s))return s===a}if(r.isPhone)return(s=this.extractPhoneNumber(t))&&s.includes(r.isPhone);if(r.isEmail)return this.emailMatch(t,i);if(n){var o=parseFloat(t.replace(/[^\d.-]/g,""));if(!isNaN(o))switch(n.operator){case">":return o>n.value;case"<":return o<n.value;case">=":return o>=n.value;case"<=":return o<=n.value;case"!=":return.001<Math.abs(o-n.value);default:return Math.abs(o-n.value)<.001}}return!(e===t||!e.includes(i))},this)},this),0===this.filteredRows.length&&this.showNoResultsMessage(e)):(this.filteredRows=this.rows.slice(),this.removeNoResultsMessage()),this.currentPage=1,this.draw(),this.callHook("onFilter",e,this.filteredRows))}parseNumericComparison(e){e=e.match(/^([<>]=?|=|!=)?\s*(\d+(?:\.\d+)?)$/);return e?{operator:e[1]||"=",value:parseFloat(e[2])}:null}emailMatch(e,t){var a,s,o;return!!/@/.test(e)&&(a=(t=t.split("@"))[0],(t=1<t.length?t[1]:"")?(s=(o=e.split("@"))[0],o=1<o.length?o[1]:"",s.includes(a)&&o.includes(t)):e.split("@")[0].includes(a))}levenshteinDistance(e,t){for(var a=e.length,s=t.length,o=[],i=0;i<=a;i++){o[i]=[];for(var r=0;r<=s;r++)o[i][r]=0}for(i=0;i<=a;i++)o[i][0]=i;for(r=0;r<=s;r++)o[0][r]=r;for(i=1;i<=a;i++)for(r=1;r<=s;r++){var n=e[i-1]===t[r-1]?0:1;o[i][r]=Math.min(o[i-1][r]+1,o[i][r-1]+1,o[i-1][r-1]+n)}return o[a][s]}fuzzyMatch(t,e){if(!t||!e||e.length<this.options.fuzzyMatch.minMatchLength)return 0;if(!t.includes(e)){var a=e.split(/\s+/).filter(function(e){return e.length>=this.options.fuzzyMatch.minMatchLength},this);if(1<a.length){for(var s=a.map(function(e){return this.fuzzyMatch(t,e)},this),o=0,i=0;i<s.length;i++)o+=s[i];var a=o/s.length,r=Math.max.apply(null,s);return r>this.options.fuzzyMatch.threshold||a>this.options.fuzzyMatch.multiWordThreshold?r:0}if(e.length<=10){for(var n=0,l=t.split(/\s+/),i=0;i<l.length;i++){var d,c=l[i];Math.abs(c.length-e.length)<=this.options.fuzzyMatch.maxDistance&&(d=this.levenshteinDistance(c.toLowerCase(),e))<=this.options.fuzzyMatch.maxDistance&&(d=1-d/Math.max(c.length,e.length),n=Math.max(n,d))}if(n>=this.options.fuzzyMatch.threshold)return n}for(var h=e.split(""),p=0,u=0,m=0,g=0,i=0;i<h.length;i++){var f=h[i],b=p;if(-1===(p=t.indexOf(f,p)))return u>=this.options.fuzzyMatch.minMatchLength&&(f=.7*(u/h.length)+.3*(g/h.length))>=this.options.fuzzyMatch.threshold?f:0;u++,p===b+1?(m++,g=Math.max(g,m)):m=0,p+=1}}return 1}sortBy(e,t){this.currentSortColumn=t?e:void 0,this.currentSortDirection=t,this.options.data.serverSide?(this.log(`Sorting server-side data by column ${e}, direction: `+t),this.loadAjax()):(t?this.filteredRows.sort(this.getComparisonFunction(e,t)):this.filteredRows.sort(function(e,t){return e.originalIndex-t.originalIndex}),this.draw()),this.callHook("onSort",e,t)}getComparisonFunction(o,i){var r=this;return function(e,t){var e=e.element.cells[o].textContent.trim(),t=t.element.cells[o].textContent.trim(),a=r.extractPhoneNumber(e),s=r.extractPhoneNumber(t);return a&&s?"asc"===i?a.localeCompare(s):s.localeCompare(a):(s=r.parseDate(e),a=r.parseDate(t),s&&a?"asc"===i?s.getTime()-a.getTime():a.getTime()-s.getTime():(a=r.extractNumber(e),s=r.extractNumber(t),isNaN(a)||isNaN(s)?"asc"===i?e.localeCompare(t):t.localeCompare(e):"asc"===i?a-s:s-a))}}extractPhoneNumber(e){return/\d/.test(e)&&(e.match(/^(?:\+?\d{1,3}[-\s.]?)?\(?(\d{3})\)?[-\s.]?(\d{3})[-\s.]?(\d{3,4})$/)||0===e.replace(/[\d\s\-().+]/g,"").length&&7<=e.replace(/[^0-9]/g,"").length)?e.replace(/[^0-9]/g,""):null}parseDate(e){if(e){var t=new Date(e);if(!isNaN(t.getTime()))return t;for(var a=[{regex:/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/,handler:function(e){return new Date(parseInt(e[3]),parseInt(e[1])-1,parseInt(e[2]))}},{regex:/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/,handler:function(e){return new Date(parseInt(e[3]),parseInt(e[2])-1,parseInt(e[1]))}},{regex:/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/,handler:function(e){return new Date(parseInt(e[1]),parseInt(e[2])-1,parseInt(e[3]))}},{regex:/^([a-zA-Z]{3,9})\s+(\d{1,2}),?\s+(\d{4})$/,handler:function(e){var t={jan:0,feb:1,mar:2,apr:3,may:4,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11,january:0,february:1,march:2,april:3,june:5,july:6,august:7,september:8,october:9,november:10,december:11}[e[1].toLowerCase()];return void 0!==t?new Date(parseInt(e[3]),t,parseInt(e[2])):null}}],s=0;s<a.length;s++){var o=e.match(a[s].regex);if(o)if((t=a[s].handler(o))&&!isNaN(t.getTime()))return t}}return null}extractNumber(e){return parseFloat(e.replace(/[^0-9.-]+/g,""))}draw(){if(this.callHook("beforeDraw"),this.options.data.serverSide){const a=this.table.querySelector("tbody");if(!a)return void console.error("SmartTables: No tbody found in table");for(;a.firstChild;)a.removeChild(a.firstChild);this.rows.forEach(e=>{a.appendChild(e.element)}),void 0!==this.currentSortColumn&&(this.log("Reapplying sort column class for column "+this.currentSortColumn),this.addSortColumnClass(this.currentSortColumn)),this.options.responsive.enabled&&0<this.hiddenColumns.length&&(this.log("Reapplying responsive column hiding for server-side data"),this.hiddenColumns.forEach(e=>{var t=this.table.querySelector(`thead th:nth-child(${e+1})`);t&&(t.style.display="none"),this.table.querySelectorAll(`tbody tr td:nth-child(${e+1})`).forEach(e=>e.style.display="none")}),this.setupResponsiveRows()),this.options.pagination&&this.updatePagination()}else{const s=(this.currentPage-1)*this.options.perPage;var e=s+this.options.perPage;const o=this.table.querySelector("tbody"),i=this.hiddenColumns.slice(),r={};for(this.filteredRows.forEach(function(e){e.expanded&&(r[e.originalIndex]=!0)});o.firstChild;)o.removeChild(o.firstChild);this.filteredRows.slice(s,e).forEach(function(e){var t=e.element.cloneNode(!0);Array.from(t.cells).forEach(function(e){e.classList.remove("st-sort-column")}),i.forEach(function(e){t.cells[e]&&(t.cells[e].style.display="none")}),o.appendChild(t),r[e.originalIndex]&&(e.expanded=!0,t.classList.add("expanded"),t.cells[0])&&(t.cells[0].classList.add("st-expand-active"),t.cells[0].classList.add("st-expand"))});var t=this.table.querySelectorAll("thead th"),e=(i.forEach(function(e){t[e]&&(t[e].style.display="none")}),this.options.responsive.enabled&&(this.setupResponsiveRows(),Array.from(o.querySelectorAll("tr.expanded")).forEach(function(e){var t=Array.from(o.querySelectorAll("tr:not(.st-child-row)")).indexOf(e),t=this.filteredRows[s+t];t&&(t.element=e,this.updateExpandedRow(t))},this)),this.table.querySelector("th.st-sort-asc, th.st-sort-desc"));e&&(e=Array.from(e.parentNode.children).indexOf(e),this.addSortColumnClass(e))}this.options.pagination&&this.updatePagination(),this.callHook("afterDraw"),this.table.classList.contains("d-none")&&this.isTableInitialized&&!this.hasDNoneBeenRemoved&&requestAnimationFrame(()=>{setTimeout(()=>{this.table.classList.remove("d-none"),this.table.style.opacity="1",this.hasDNoneBeenRemoved=!0,this.log("TABLE READY: Removed d-none class after all calculations")},300)})}updatePagination(){this.paginationContainer&&this.paginationContainer.remove();const s=this.options.data.serverSide?this.totalRows:this.filteredRows.length,o=(this.log("Pagination using total rows:",s,"Current search:",this.searchQuery),Math.ceil(s/this.options.perPage));var e=document.createElement("div"),t=(e.className="row",document.createElement("div")),a=(t.className="col-12 col-sm-6 d-flex align-items-center justify-content-sm-start justify-content-center gap-2 order-1 order-sm-0",document.createElement("div")),i=(a.className="dropdown",document.createElement("button")),r=(i.className="btn btn-sm btn-outline-secondary dropdown-toggle pe-2 ps-2 py-1 no-arrow",i.setAttribute("data-bs-toggle","dropdown"),i.innerHTML=this.options.perPage+' <i class="sa sa-chevron-down"></i>',document.createElement("ul")),n=(r.className="dropdown-menu",this),a=([10,15,25,50,100,"All"].forEach(function(t){var e=document.createElement("li"),a=document.createElement("a");a.className="dropdown-item"+(n.options.perPage===t?" active":""),a.href="#",a.textContent=t,a.addEventListener("click",function(e){e.preventDefault();e="All"===t?n.options.data.serverSide?s:n.filteredRows.length:t;n.options.perPage=e,i.innerHTML=t+' <i class="sa sa-chevron-down"></i>',n.currentPage=1,n.options.data.serverSide?n.loadAjax():n.draw(),r.querySelectorAll(".dropdown-item").forEach(function(e){e.classList.remove("active")}),this.classList.add("active")}),e.appendChild(a),r.appendChild(e)}),a.appendChild(i),a.appendChild(r),t.appendChild(a),(this.currentPage-1)*this.options.perPage+1),l=Math.min(a+this.options.perPage-1,s),d=document.createElement("div"),a=(d.className="text-muted small",d.textContent=`Showing ${a} to ${l} of ${s} entries`,t.appendChild(d),document.createElement("div")),l=(a.className="col-12 col-sm-6 d-flex align-items-center justify-content-sm-end justify-content-center mb-4 mb-sm-0",document.createElement("nav")),c=document.createElement("ul"),d=(c.className="pagination pagination-sm mb-0",document.createElement("li")),h=(d.className="page-item st-first-page"+(1===this.currentPage?" disabled":""),document.createElement("a")),h=(h.className="page-link",h.href="#",h.innerHTML="«",d.appendChild(h),c.appendChild(d),document.createElement("li")),d=(h.className="page-item st-prev-page"+(1===this.currentPage?" disabled":""),document.createElement("a")),d=(d.className="page-link",d.href="#",d.innerHTML='<span class="d-none d-sm-none d-md-inline-block">Prev</span> <span class="d-inline-block d-sm-inline-block d-md-none">‹</span>',h.appendChild(d),c.appendChild(h),Math.max(1,this.currentPage-1)),p=Math.min(o,d+2);1<(d=Math.max(1,p-2))&&(c.appendChild(this.createPageItem("1")),2<d)&&((h=document.createElement("li")).className="page-item disabled",h.innerHTML='<span class="page-link">...</span>',c.appendChild(h));for(var u=d;u<=p;u++)c.appendChild(this.createPageItem(u.toString(),u===this.currentPage));p<o&&(p<o-1&&((h=document.createElement("li")).className="page-item disabled",h.innerHTML='<span class="page-link">...</span>',c.appendChild(h)),c.appendChild(this.createPageItem(o.toString())));d=document.createElement("li"),d.className="page-item st-next-page"+(this.currentPage===o?" disabled":""),h=document.createElement("a"),h.className="page-link",h.href="#",h.innerHTML='<span class="d-none d-sm-none d-md-inline-block">Next</span> <span class="d-inline-block d-sm-inline-block d-md-none">›</span>',d.appendChild(h),c.appendChild(d),h=document.createElement("li"),h.className="page-item st-last-page"+(this.currentPage===o?" disabled":""),d=document.createElement("a");d.className="page-link",d.href="#",d.innerHTML="»",h.appendChild(d),c.appendChild(h),l.appendChild(c),a.appendChild(l),e.appendChild(t),e.appendChild(a),this.paginationContainer=e,this.wrapper.appendChild(e),c.addEventListener("click",function(e){e.preventDefault();e=e.target.closest(".page-link");if(e){n.isLoadingAjax&&(n.log("🔄 PAGE CHANGE: Detected click while loading AJAX"),n.clearHangingRequests());var t=n.currentPage,a=e.closest(".page-item");if(a.classList.contains("st-first-page")?t=1:a.classList.contains("st-prev-page")?t=n.currentPage-1:a.classList.contains("st-next-page")?t=n.currentPage+1:a.classList.contains("st-last-page")?t=o:(a=e.getAttribute("data-page"))&&(t=parseInt(a)),t!==n.currentPage&&1<=t&&t<=o){e=n.currentPage;if(n.currentPage=t,n.log(`Changing page from ${e} to ${t} with search: "${n.searchQuery}"`),n.options.data.serverSide){n.currentPage;a=n.generateCacheKey();if(n.ajaxCache.has(a)){n.log(`🔄 PAGE CHANGE: Found cached data for page ${t} with key ${a}, search: "${n.searchQuery}"`);e=n.ajaxCache.get(a);if(e&&e.total&&n.options.data.prefetch){const o=Math.ceil(e.total/n.options.perPage);t<o&&(n.log(`🔄 PAGE CHANGE: Manually triggering prefetch for page ${t+1} after using cached data, search: "${n.searchQuery}"`),setTimeout(()=>{n.prefetchNextPage()},100))}}else n.log(`🔄 PAGE CHANGE: No cache found for page ${t}, search: "${n.searchQuery}"`),n.log("🔄 PAGE CHANGE: Available cache keys:",Array.from(n.ajaxCache.keys()));n.log(`Loading server-side data for page ${t}, search: "${n.searchQuery}"`),n.loadAjax()}else n.log(`🔄 PAGE CHANGE: Redrawing with client-side data for page ${t}, search: "${n.searchQuery}"`),n.draw();n.callHook("onPaginate",t,n)}}})}createPageItem(e,t){var a=document.createElement("li"),t=(a.className="page-item"+(t?" active":""),document.createElement("a"));return t.className="page-link",t.href="#",t.textContent=e,t.setAttribute("data-page",e),a.appendChild(t),a}setupResponsive(){var o,e,i;this.options.responsive.enabled&&((o=this).responsiveColumns=[],e=Array.from(this.table.querySelectorAll("thead th")),(i=this.table.querySelector("colgroup"))?i.innerHTML="":(i=document.createElement("colgroup"),this.table.insertBefore(i,this.table.firstChild)),e.forEach(function(e,t){var a=document.createElement("col"),s=(i.appendChild(a),e.getAttribute("data-priority")||o.options.responsive.columnPriorities&&o.options.responsive.columnPriorities[t]||t+1);o.responsiveColumns.push({index:t,header:e,col:a,priority:parseInt(s,10),minWidth:null,visible:!0,alwaysVisible:e.classList.contains("always-visible")||!1,neverVisible:e.classList.contains("never-visible")||!1,sortClass:!1})}),this.calculateColumnWidths(),window.ResizeObserver?(this.resizeObserver&&this.resizeObserver.disconnect(),this.resizeObserver=new ResizeObserver(function(){o.checkResponsiveDisplay(),o.updateExpandedRowsAfterResize(),o.callHook("onResize",o)}),this.resizeObserver.observe(this.wrapper)):window.addEventListener("resize",function(){o.checkResponsiveDisplay(),o.updateExpandedRowsAfterResize(),o.callHook("onResize",o)}),this.checkResponsiveDisplay())}checkResponsiveDisplay(){var e,t=this,a=this.wrapper.offsetWidth,s=(this.log("checkResponsiveDisplay - Current table width:",a),0);this.responsiveColumns.forEach(function(e){s+=e.minWidth}),this.log("Total required width for all columns:",s),s<=a?(this.log("All columns fit, showing all"),this.responsiveColumns.forEach(function(e){t.showColumn(e.index)}),this.updateExpandIndicators(),this.options.data.serverSide&&(this.log("Server-side data: Updating expanded rows after showing all columns"),this.updateExpandedRowsAfterResize())):(e=this.responsiveColumns.slice().sort(function(e,t){return t.priority-e.priority}),this.log("Hiding columns by priority until they fit"),e.forEach(function(e){e.alwaysVisible?t.log("Column",e.index,"is always visible, skipping"):a<s?(t.log("Hiding column",e.index,"to save",e.minWidth,"px"),t.hideColumn(e.index),s-=e.minWidth,t.log("Required width now:",s)):(t.log("Showing column",e.index),t.showColumn(e.index))}),this.updateColWidths(),this.updateExpandIndicators(),this.options.data.serverSide&&(this.log("Server-side data: Updating expanded rows after responsive changes"),this.updateExpandedRowsAfterResize()),this.log("Final hidden columns:",this.hiddenColumns))}updateColWidths(){this.wrapper.offsetWidth;var e=this.responsiveColumns.filter(function(e){return e.visible}),a=e.reduce(function(e,t){return e+t.minWidth},0);e.forEach(function(e){var t=e.minWidth/a*100;e.col.style.width=t+"%"})}hideColumn(t){var e=this.responsiveColumns.find(function(e){return e.index===t});e&&e.visible&&(e.visible=!1,e.header.style.display="none",this.table.querySelectorAll("tbody tr td:nth-child("+(t+1)+")").forEach(function(e){e.style.display="none"}),-1===this.hiddenColumns.indexOf(t)&&this.hiddenColumns.push(t),this.emitEvent("columnHide",[t]))}showColumn(t){var e=this.responsiveColumns.find(function(e){return e.index===t});e&&!e.visible&&(e.visible=!0,e.header.style.display="",this.table.querySelectorAll("tbody tr td:nth-child("+(t+1)+")").forEach(function(e){e.style.display=""}),-1!==(e=this.hiddenColumns.indexOf(t))&&this.hiddenColumns.splice(e,1),this.emitEvent("columnShow",[t]))}showNotification(e,t){var a="st-toast-container",s=document.getElementById(a),a=(s||((s=document.createElement("div")).className="toast-container position-fixed top-0 end-0 p-3",s.id=a,document.body.appendChild(s)),"st-toast-"+Date.now()),o="bg-primary",i="✓";switch(t){case"success":o="bg-success text-white",i="✓";break;case"info":o="bg-info text-white",i="ℹ";break;case"warning":o="bg-warning",i="⚠";break;case"danger":case"error":o="bg-danger text-white",i="⚠"}var r=document.createElement("div"),t=(r.className="toast "+o+" align-items-center border-0 py-2 px-3",r.id=a,r.setAttribute("role","alert"),r.setAttribute("aria-live","assertive"),r.setAttribute("aria-atomic","true"),document.createElement("div")),a=(t.className="d-flex",document.createElement("div")),e=(a.className="toast-body d-flex align-items-center justify-content-center",a.innerHTML=i+" "+e,document.createElement("button"));e.type="button",e.className="btn btn-system ms-auto",e.setAttribute("data-bs-dismiss","toast"),e.setAttribute("aria-label","Close"),document.querySelector('use[href*="sprite.svg#x"]')?e.innerHTML='<svg class="sa-icon sa-icon-light"><use href="img/sprite.svg#x"></use></svg>':e.innerHTML="×",t.appendChild(a),t.appendChild(e),r.appendChild(t),s.appendChild(r),new bootstrap.Toast(r,{animation:!0,autohide:!0,delay:3e3}).show(),r.addEventListener("hidden.bs.toast",function(){r.remove(),0===s.children.length&&s.remove()})}addSortColumnClass(e){this.toggleSortColumnClass(e,!0)}removeSortColumnClass(e){this.toggleSortColumnClass(e,!1)}toggleSortColumnClass(e,t){var a,s=t?"add":"remove";this.table.querySelectorAll("tbody tr td:nth-child("+(e+1)+")").forEach(function(e){e.classList[s]("st-sort-column")}),this.hiddenColumns.includes(e)&&(t=this.table.querySelector("thead th:nth-child("+(e+1)+")"))&&(a=t.textContent,this.table.querySelectorAll(".st-hidden-column-item").forEach(function(e){var t=e.querySelector(".st-hidden-column-label");t&&t.textContent.startsWith(a)&&e.classList[s]("st-sort-column")}))}showNoResultsMessage(e){this.removeNoResultsMessage();var t=document.createElement("div");t.className="st-no-results alert alert-info mt-3",t.innerHTML='<svg class="sa-icon sa-thin sa-icon-2x sa-bold sa-icon-info hidden-sm"><use href="img/sprite.svg#frown"></use></svg> <h6 class="mb-0">No search results found for <b>"'+e+'"</b></h6>',this.wrapper.appendChild(t)}removeNoResultsMessage(){var e=this.wrapper.querySelector(".st-no-results");e&&e.remove()}async delete(o,e={}){var{showNotifications:t=!0}=e,e=(this.callHook("beforeDelete",o,e),await new Promise(e=>{var t="st-delete-modal-"+o,a=`
                <div class="modal fade" id="${t}" tabindex="-1" aria-hidden="true" style="--bs-modal-width: 450px;">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content bg-dark bg-opacity-50 shadow-5 translucent-dark">
                            <div class="modal-header border-bottom-0">
                                <h4 class="modal-title text-white d-flex align-items-center">
                                    Delete record
                                </h4>
                                <button type="button" class="btn btn-system btn-system-light ms-auto" data-bs-dismiss="modal" aria-label="Close">
                                    <svg class="sa-icon sa-icon-2x">
                                        <use href="img/sprite.svg#x"></use>
                                    </svg>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-danger bg-danger border-danger text-light border-opacity-50 bg-opacity-10 mb-0">
                                    Are you sure you want to delete record <span class="fw-600 text-danger">[${o}]</span> <br>
                                    This action cannot be undone.
                                </div>
                            </div>
                            <div class="modal-footer border-top-0">
                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">No, cancel</button>
                                <button type="button" class="btn btn-danger" id="confirm-${t}">Yes, delete</button>
                            </div>
                        </div>
                    </div>
                </div>`,a=SmartTables.createNode(a);document.body.appendChild(a);const s=document.getElementById(t);s.addEventListener("hidden.bs.modal",()=>{s.remove()}),document.getElementById("confirm-"+t).addEventListener("click",()=>{e(!0),bootstrap.Modal.getInstance(s).hide()}),s.querySelector('[data-bs-dismiss="modal"]').addEventListener("click",()=>{e(!1)}),new bootstrap.Modal(s).show()}));if(!e)return this.log("Delete operation aborted by user"),!1;e=this.table.querySelector(`tbody tr[data-id="${o}"]`);if(Array.isArray(this.options.data.source)){this.log("Using client-side delete for row ID:",o);const n=this.options.data.idField||"id";var a=this.options.data.source.findIndex(e=>{e=void 0!==e[n]?e[n]:void 0!==e[n.toUpperCase()]?e[n.toUpperCase()]:null;return null!==e&&e.toString()===o.toString()});if(-1===a)throw s=new Error("Record not found for deletion"),e&&e.classList.remove("deleting"),t&&this.showNotification("Failed to delete record: Record not found","danger"),this.callHook("afterDelete",o,null,!1),s;this.options.data.source.splice(a,1);var e=this.options.data.source.length,s=Math.ceil(e/this.options.perPage);return this.currentPage>s&&0<s&&(this.currentPage=s,this.log("Adjusted current page to",this.currentPage,"after deletion")),this.updateTableData(this.options.data.source),this.searchQuery&&""!==this.searchQuery.trim()&&setTimeout(()=>this.handleSearch(this.searchQuery),50),t&&this.showNotification(`Record #${o} deleted successfully`,"success"),this.callHook("afterDelete",o,{success:!0},!0),!0}a=this.options.data.source+"/"+o,e={method:"DELETE",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...this.options.data.headers}};this.log("Sending DELETE request to:",a);try{var i=await fetch(a,e);if(!i.ok)throw new Error("HTTP error! Status: "+i.status);var r=await i.json();if(r.success)return this.log("Delete successful for row ID:",o),this.clearAjaxCache(),this.loadAjax(),t&&this.showNotification(`Record #${o} deleted successfully`,"success"),this.callHook("afterDelete",o,r,!0),!0;throw new Error(r.error||"Failed to delete record")}catch(e){throw this.log("Delete failed for row ID:",o,"Error:",e.message),t&&this.showNotification("Failed to delete record: "+e.message,"danger"),this.callHook("afterDelete",o,null,!1),e}}async edit(d,e=null,c={}){const{showNotifications:h=!0,title:t="Edit Record",submitButtonText:a="Save Changes",cancelButtonText:s="Cancel"}=c;if(!1===this.callHook("beforeEdit",d,e,c))return this.log("Edit operation aborted by beforeEdit hook"),!1;var o=this.table.querySelector(`tbody tr[data-id="${d}"]`);if(!o)return h&&this.showNotification("Error: Row not found","danger"),this.callHook("afterEdit",d,null,!1),!1;let p=e;if(!p)if(Array.isArray(this.options.data.source)){const i=this.options.data.idField||"id";e=this.options.data.source.find(e=>{e=void 0!==e[i]?e[i]:void 0!==e[i.toUpperCase()]?e[i.toUpperCase()]:null;return null!==e&&e.toString()===d.toString()});if(!e)return h&&this.showNotification("Error: Record data not found","danger"),this.callHook("afterEdit",d,null,!1),!1;p={...e}}else{p={};const r=Array.from(o.cells);this.options.data.columns.forEach((e,t)=>{e.data&&r[t]&&(p[e.data]=r[t].textContent.trim())})}const u="st-edit-modal-"+Date.now();e=`
        <div class="modal fade" id="${u}" tabindex="-1" role="dialog" aria-labelledby="${u}-label" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="${u}-label">${t}</h5>
                        <button class="btn btn-system ms-auto" type="button" data-bs-dismiss="modal" aria-label="Close">
                            <svg class="sa-icon sa-icon-2x">
                                <use href="img/sprite.svg#x"></use>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="${u}-form">
                            ${this.generateEditFormFields(p)}
                            <input type="hidden" name="rowId" value="${d}">
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${s}</button>
                        <button type="button" class="btn btn-primary" id="${u}-submit">${a}</button>
                    </div>
                </div>
            </div>
        </div>
        `,o=this.callHook("onEditModalCreated",e,d,p,c);document.body.insertAdjacentHTML("beforeend",o||e);const m=document.getElementById(u),g=new bootstrap.Modal(m);return this.callHook("onEditModalBeforeShow",m,d,p,c),g.show(),this.callHook("onEditModalAfterShow",m,d,p,c),new Promise((n,l)=>{document.getElementById(u+"-submit").addEventListener("click",async e=>{var t=document.getElementById(u+"-form");if(t.checkValidity()){var a,s,o={};for([a,s]of new FormData(t).entries())"rowId"!==a&&(o[a]=s);var i=this.callHook("onEditDataCollected",o,d,p,c)||o;g.hide();try{var r=await this.applyEdit(d,i,c);m.addEventListener("hidden.bs.modal",()=>{m.remove()}),n(r)}catch(e){h&&this.showNotification("Failed to update record: "+e.message,"danger"),m.addEventListener("hidden.bs.modal",()=>{m.remove()}),l(e)}}else e.preventDefault(),e.stopPropagation(),t.classList.add("was-validated"),this.showNotification("Please fill all required fields correctly","danger")}),m.addEventListener("hidden.bs.modal",()=>{m.parentNode&&(m.remove(),this.callHook("onEditCancelled",d,p,c),n(!1))})})}generateEditFormFields(e){let t="";for(const l of this.options.data.columns)if(l.data&&!1!==l.editable){const d=e[l.data]||"";var s=l.title||l.data,o="edit-field-"+l.data;let a;if("boolean"===l.type||"boolean"==typeof d)a=`
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="${o}" name="${l.data}" 
                            ${!0===d||"true"===d||"1"===d?"checked":""}>
                        <label class="form-check-label" for="${o}">${s}${l.required?' <span class="fw-bold text-danger">*</span>':""}</label>
                    </div>
                `;else if("select"===l.type&&l.options){var i=l.options.map(e=>{var t="object"==typeof e?e.value:e,e="object"==typeof e?e.label:e;return`<option value="${t}" ${t==d?"selected":""}>${e}</option>`}).join("");a=`
                    <div class="mb-3">
                        <label for="${o}" class="form-label">${s}${l.required?' <span class="fw-bold text-danger">*</span>':""}</label>
                        <select class="form-select" id="${o}" name="${l.data}">
                            ${i}
                        </select>
                    </div>
                `}else if("textarea"===l.type||d&&100<d.length)a=`
                    <div class="mb-3">
                        <label for="${o}" class="form-label">${s}${l.required?' <span class="fw-bold text-danger">*</span>':""}</label>
                        <textarea class="form-control" id="${o}" name="${l.data}" rows="3">${d}</textarea>
                    </div>
                `;else{let e="text",t="";if("number"===l.type||"number"===l.format)e="number",void 0!==l.step&&(t+=` step="${l.step}"`),void 0!==l.min&&(t+=` min="${l.min}"`),void 0!==l.max&&(t+=` max="${l.max}"`);else if("date"===l.type||"date"===l.format){e="date";try{var r,n=new Date(d);isNaN(n.getTime())||(r=n.toISOString().split("T")[0],d=r)}catch(e){}}else"email"===l.type||"email"===l.format?e="email":"tel"===l.type||"phone"===l.format?(e="tel",l.pattern&&(t+=` pattern="${l.pattern}"`)):"url"===l.type?e="url":"password"===l.type?e="password":"time"===l.type?e="time":"color"===l.type&&(e="color");l.placeholder&&(t+=` placeholder="${l.placeholder}"`),l.required&&(t+=" required"),a=`
                    <div class="mb-3">
                        <label for="${o}" class="form-label">${s}${l.required?' <span class="fw-bold text-danger">*</span>':""}</label>
                        <input type="${e}" class="form-control" id="${o}" name="${l.data}" value="${this.escapeHTML(d.toString())}"${t}>
                    </div>
                `}t+=a}return t}async applyEdit(t,a,e={}){var{showNotifications:s=!0}=e;if(!1===this.callHook("beforeApplyEdit",t,a,e))return this.log("Apply edit operation aborted by beforeApplyEdit hook"),!1;this.table.querySelector(`tbody tr[data-id="${t}"]`);if(Array.isArray(this.options.data.source)){this.log("Using client-side edit for row ID:",t);try{const l=this.options.data.idField||"id";var o=this.options.data.source.findIndex(e=>{e=void 0!==e[l]?e[l]:void 0!==e[l.toUpperCase()]?e[l.toUpperCase()]:null;return null!==e&&e.toString()===t.toString()});if(-1===o)throw new Error("Record not found for editing");var i=this.callHook("onProcessEditData",a,t,this.options.data.source[o],e)||a;return this.options.data.source[o]={...this.options.data.source[o],...i},this.log("Updated client-side data:",this.options.data.source[o]),this.updateTableData(this.options.data.source),this.searchQuery&&""!==this.searchQuery.trim()&&setTimeout(()=>this.handleSearch(this.searchQuery),50),s&&this.showNotification(`Record #${t} updated successfully`,"success"),this.callHook("afterEdit",t,this.options.data.source[o],!0),this.callHook("onEditSuccess",t,this.options.data.source[o],i),!0}catch(e){throw s&&this.showNotification("Failed to update record: "+e.message,"danger"),this.callHook("afterEdit",t,null,!1),this.callHook("onEditError",t,e,a),e}}o=this.options.data.source+"/"+t,i={method:"PUT",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...this.options.data.headers},body:JSON.stringify(a)},e=this.callHook("onEditFetchOptions",i,t,a,e)||i;this.log("Sending PUT request to:",o);try{var r=await fetch(o,e);if(!r.ok)throw new Error("HTTP error! Status: "+r.status);var n=await r.json();if(n.success)return this.log("Edit successful for row ID:",t),this.clearAjaxCache(),this.loadAjax(),s&&this.showNotification(`Record #${t} updated successfully`,"success"),this.callHook("afterEdit",t,n,!0),this.callHook("onEditSuccess",t,n,a),!0;throw new Error(n.error||"Failed to update record")}catch(e){throw this.log("Edit failed for row ID:",t,"Error:",e.message),s&&this.showNotification("Failed to update record: "+e.message,"danger"),this.callHook("afterEdit",t,null,!1),this.callHook("onEditError",t,e,a),e}}destroy(){if(Array.isArray(this.plugins)||(this.plugins=[]),this.callHook("beforeDestroy"),this.isTableInitialized=!1,this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.table&&this.table.querySelectorAll("th").forEach(function(e){e._sortHandler&&(e.removeEventListener("click",e._sortHandler),delete e._sortHandler)}),this.rows=[],this.filteredRows=[],this.originalRows=[],this.hiddenColumns=[],this.columnWidths=[],this.currentPage=1,this.table){for(var e,t=this.table.parentNode,a=this.table.tagName,s=this.table.id,o=this.options.classes.table,i={},r=0;r<this.table.attributes.length;r++){var n=this.table.attributes[r];"id"!==n.name&&"class"!==n.name&&(i[n.name]=n.value)}for(e in this.table.remove(),this.table=document.createElement(a),s&&(this.table.id=s),this.table.className=o,i)this.table.setAttribute(e,i[e]);this.wrapper?this.wrapper.appendChild(this.table):t&&t.appendChild(this.table)}this.toolbar&&(this.toolbar.remove(),this.toolbar=null),this.paginationContainer&&(this.paginationContainer.remove(),this.paginationContainer=null);a=this.wrapper.querySelector(".st-no-results");a&&a.remove();this.wrapper.querySelectorAll("tr.child").forEach(function(e){e.remove()});s=this.wrapper.querySelector(".st-search");s&&(s.value=""),this.sortColumn=null,this.sortDirection=null,setTimeout(function(){window.gc&&window.gc()},100),this.plugins.forEach(function(e){"function"==typeof e.destroy&&e.destroy()}),this.plugins=[],this.callHook("afterDestroy")}initializePlugins(){this.plugins=[],Array.isArray(this.options.plugins)&&this.options.plugins.forEach(function(e){this.registerPlugin(e)},this)}registerPlugin(e){if("object"==typeof e&&e.name){var t,a={name:e.name,instance:this};for(t in e)"name"!==t&&"function"==typeof e[t]&&(a[t]=e[t].bind(a));"function"==typeof a.init&&a.init(),this.plugins.push(a),console.log("Plugin registered:",e.name)}else console.error("Invalid plugin format. Plugin must be an object with a name property.")}getPlugin(t){return this.plugins.find(function(e){return e.name===t})}callHook(t,...a){let e;if(this.options.hooks&&"function"==typeof this.options.hooks[t]&&(a[a.length-1]!==this&&a.push(this),!1===(e=this.options.hooks[t].apply(this,a))))return!1;Array.isArray(this.plugins)||(this.plugins=[]);for(let e=0;e<this.plugins.length;e++){var s=this.plugins[e];if("function"==typeof s[t])if(!1===s[t].apply(s,a))return!1}return this.emitEvent(t,a),e}emitEvent(e,t){e=new CustomEvent("st:"+e,{detail:{instance:this,args:t},bubbles:!0,cancelable:!0});this.table.dispatchEvent(e)}setupResponsiveRows(){if(this.options.responsive.enabled){const o=this,i=this.table.querySelector("tbody");i&&(i._expandClickHandler&&i.removeEventListener("click",i._expandClickHandler),i._expandClickHandler=e=>{var t,a=e.target.closest("td:first-child");if(a&&0!==o.hiddenColumns.length&&!e.target.closest(".st-child-row")){const s=a.closest("tr");s&&(o.options.data.serverSide?s.classList.contains("expanded")?(s.classList.remove("expanded"),a&&a.classList.remove("st-expand-active"),(e=s.nextElementSibling)&&e.classList.contains("st-child-row")&&e.remove()):(s.classList.add("expanded"),a&&a.classList.add("st-expand-active"),e={element:s,expanded:!0},o.updateExpandedRow(e),setTimeout(()=>{var e=s.nextElementSibling;e&&e.classList.contains("st-child-row")&&o.initializeBootstrapComponents(e)},0)):(a=Array.from(i.querySelectorAll("tr:not(.st-child-row)")).indexOf(s),e=(o.currentPage-1)*o.options.perPage,(t=o.filteredRows[e+a])?(t.element=s,t.expanded=!t.expanded,o.updateExpandedRow(t)):console.warn("Could not find row data for index:",e+a)))}},i.addEventListener("click",i._expandClickHandler),0<this.hiddenColumns.length?i.querySelectorAll("tr:not(.st-child-row)").forEach((e,t)=>{var a;0<e.cells.length&&((a=e.cells[0]).classList.add("st-expand"),o.options.data.serverSide?e.classList.contains("expanded")&&(a.classList.add("st-expand-active"),e={element:e,expanded:!0},o.updateExpandedRow(e)):(e=(o.currentPage-1)*o.options.perPage,(e=o.filteredRows[e+t])&&e.expanded&&(a.classList.add("st-expand-active"),o.updateExpandedRow(e))))}):(i.querySelectorAll("tr:not(.st-child-row)").forEach(e=>{0<e.cells.length&&e.cells[0].classList.remove("st-expand","st-expand-active")}),this.filteredRows.forEach(e=>{e&&(e.expanded=!1)}),i.querySelectorAll(".st-child-row").forEach(e=>e.remove())))}}updateExpandedRow(e){var o,t,i;e&&e.element?(o=e.element).parentNode?0===this.hiddenColumns.length?e.expanded=!1:(e.expanded?o.classList.add("expanded"):o.classList.remove("expanded"),(t=o.cells[0])&&(t.classList.add("st-expand"),e.expanded?t.classList.add("st-expand-active"):t.classList.remove("st-expand-active")),(t=o.nextElementSibling)&&t.classList.contains("st-child-row")&&t.remove(),e.expanded&&((t=document.createElement("tr")).className="st-child-row",(e=document.createElement("td")).colSpan=o.cells.length,e.className="st-child-content",(i=document.createElement("div")).className="st-hidden-columns gap-2 gap-md-2",this.hiddenColumns.forEach(function(e){var t,a,s=this.table.querySelector("thead th:nth-child("+(e+1)+")");s&&(s=s.textContent,e=e<o.cells.length&&o.cells[e]?o.cells[e].innerHTML:"",(t=document.createElement("div")).className="st-hidden-column-item flex-column flex-md-column flex-lg-row",(a=document.createElement("span")).className="st-hidden-column-label",a.textContent=s+": ",(s=document.createElement("span")).className="st-hidden-column-value",s.innerHTML=e,t.appendChild(a),t.appendChild(s),i.appendChild(t))},this),e.appendChild(i),t.appendChild(e),o.parentNode.insertBefore(t,o.nextSibling),this.initializeBootstrapComponents(t))):console.warn("Row is not in the DOM"):console.warn("Invalid row data")}initializeBootstrapComponents(e){if(this.log("Initializing interactive components for expanded row content"),"undefined"!=typeof bootstrap&&bootstrap.Popover&&e.querySelectorAll('[data-bs-toggle="popover"]').forEach(e=>{try{new bootstrap.Popover(e),this.log("Initialized Bootstrap popover")}catch(e){this.log("Error initializing Bootstrap popover:",e)}}),"undefined"!=typeof bootstrap&&bootstrap.Tooltip&&e.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e=>{try{new bootstrap.Tooltip(e),this.log("Initialized Bootstrap tooltip")}catch(e){this.log("Error initializing Bootstrap tooltip:",e)}}),"undefined"!=typeof bootstrap&&bootstrap.Dropdown&&e.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(e=>{try{new bootstrap.Dropdown(e),this.log("Initialized Bootstrap dropdown")}catch(e){this.log("Error initializing Bootstrap dropdown:",e)}}),"undefined"!=typeof $&&void 0!==$.fn)try{"function"==typeof $.fn.popover&&($(e).find('[data-toggle="popover"]').popover(),this.log("Initialized jQuery popovers")),"function"==typeof $.fn.tooltip&&($(e).find('[data-toggle="tooltip"]').tooltip(),this.log("Initialized jQuery tooltips")),"function"==typeof $.fn.dropdown&&($(e).find('[data-toggle="dropdown"]').dropdown(),this.log("Initialized jQuery dropdowns"))}catch(e){this.log("Error initializing jQuery Bootstrap components:",e)}var t=new CustomEvent("smarttables:components-init",{detail:{element:e},bubbles:!0,cancelable:!0}),t=(e.dispatchEvent(t),new CustomEvent("smarttables:row-expanded",{detail:{element:e},bubbles:!0}));e.dispatchEvent(t),this.callHook("onExpandedRowInit",e)}updateExpandedRowsAfterResize(){var e,r=this,a=this.table.querySelector("tbody");a&&(e=Array.from(a.querySelectorAll("tr.expanded")),this.options.data.serverSide?e.forEach(function(o){Array.from(a.querySelectorAll("tr:not(.st-child-row)")).indexOf(o);var e=o.nextElementSibling,e=(e&&e.classList.contains("st-child-row")&&e.remove(),document.createElement("tr")),t=(e.className="st-child-row",document.createElement("td")),i=(t.colSpan=o.cells.length,t.className="st-child-content",document.createElement("div"));i.className="st-hidden-columns gap-2 gap-md-2",r.hiddenColumns.forEach(function(e){var t,a,s=r.table.querySelector("thead th:nth-child("+(e+1)+")");s&&(s=s.textContent,e=e<o.cells.length&&o.cells[e]?o.cells[e].innerHTML:"",(t=document.createElement("div")).className="st-hidden-column-item flex-column flex-md-column flex-lg-row",(a=document.createElement("span")).className="st-hidden-column-label",a.textContent=s+": ",(s=document.createElement("span")).className="st-hidden-column-value",s.innerHTML=e,t.appendChild(a),t.appendChild(s),i.appendChild(t))}),t.appendChild(i),e.appendChild(t),o.parentNode.insertBefore(e,o.nextSibling),r.initializeBootstrapComponents(e)}):(e.forEach(function(t){var e=r.filteredRows.find(function(e){return e&&e.element&&(e.element===t||e.element.isEqualNode(t))});e&&r.updateExpandedRow(e)}),this.filteredRows.forEach(function(e){e&&e.expanded&&e.element&&!e.element.classList.contains("expanded")&&(e.element.classList.add("expanded"),r.updateExpandedRow(e))})))}updateExpandIndicators(){var e;this.options.responsive.enabled&&(e=this.table.querySelector("tbody"))&&(0<this.hiddenColumns.length?e.querySelectorAll("tr:not(.st-child-row)").forEach(function(e){0<e.cells.length&&((e=e.cells[0]).classList.add("st-expand"),e.style.cursor="pointer")}):(e.querySelectorAll("tr:not(.st-child-row)").forEach(function(e){0<e.cells.length&&((e=e.cells[0]).classList.remove("st-expand","st-expand-active"),e.style.cursor="")}),e.querySelectorAll(".st-child-row").forEach(function(e){e.remove()}),this.filteredRows.forEach(function(e){e.expanded=!1})))}log(...e){this.options.debug&&console.log("[SmartTables]",...e)}exportData(e){var t=this.getExportData();switch(this.callHook("onExport",e,t),e){case"excel":this.exportToExcel(t);break;case"csv":this.exportToCSV(t);break;case"copy":this.copyToClipboard(t);break;case"pdf":this.exportToPDF(t);break;case"json":this.exportToJSON(t);break;case"xml":this.exportToXML(t);break;case"html":this.exportToHTML(t)}}getExportData(){return{headers:Array.from(this.table.querySelectorAll("thead th")).map(function(e){return e.textContent.trim()}),rows:this.filteredRows.map(function(e){return Array.from(e.element.cells).map(function(e){return e.textContent.trim()})})}}exportToExcel(e){var t=XLSX.utils.book_new(),a=XLSX.utils.aoa_to_sheet([e.headers].concat(e.rows)),e=(a["!cols"]=e.headers.map(function(){return{wch:15}}),XLSX.utils.book_append_sheet(t,a,"Sheet1"),"export_"+(new Date).toISOString().slice(0,19).replace(/[-:]/g,"")+".xlsx");XLSX.writeFile(t,e),this.showNotification("Successfully exported to "+e,"success")}exportToCSV(e){let t="";t+=e.headers.join(",")+"\n",e.rows.forEach(function(e){e=e.map(function(e){return e.includes(",")||e.includes('"')||e.includes("\n")?'"'+e.replace(/"/g,'""')+'"':e});t+=e.join(",")+"\n"});var a,e=(this.table.id||"table-export")+"-"+(new Date).toISOString().slice(0,10)+".csv",s=new Blob([t],{type:"text/csv;charset=utf-8;"});navigator.msSaveBlob?navigator.msSaveBlob(s,e):void 0!==(a=document.createElement("a")).download&&(s=URL.createObjectURL(s),a.setAttribute("href",s),a.setAttribute("download",e),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s),this.showNotification("Successfully exported to "+e,"success"))}copyToClipboard(e){let t="";if(t+=e.headers.join("\t")+"\n",e.rows.forEach(function(e){t+=e.join("\t")+"\n"}),navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(t).then(()=>{this.showNotification("Copied to clipboard!","success")}).catch(e=>{this.showNotification("Copy failed: "+e,"error")});else{e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.opacity="0",document.body.appendChild(e);try{e.select(),document.execCommand("copy")?this.showNotification("Copied to clipboard!","success"):this.showNotification("Copy failed. Please try again.","error")}catch(e){this.showNotification("Copy failed: "+e,"error")}finally{document.body.removeChild(e)}}}exportToJSON(t){try{const n=Array.from(this.table.querySelectorAll("thead th")).map(e=>e.textContent.trim()).map(e=>e.replace(/\s+/g,"_"));let e;e=t&&t.rows&&Array.isArray(t.rows)?t.rows.map(e=>{const a={};return e.forEach((e,t)=>{t<n.length&&(a[n[t]]=e)}),a}):Array.isArray(t)?t.map(e=>{const a={};return e.forEach((e,t)=>{t<n.length&&(a[n[t]]=e)}),a}):(console.log("Unexpected data structure for JSON export:",t),e=[],Array.from(this.table.querySelectorAll("tbody tr")).map(e=>{const a={};return Array.from(e.querySelectorAll("td")).forEach((e,t)=>{t<n.length&&(a[n[t]]=e.textContent.trim())}),a}));var a,s,o=JSON.stringify(e,null,2),i=new Blob([o],{type:"application/json"}),r=`table_export_${(new Date).toISOString().slice(0,10)}.json`;return navigator.msSaveBlob?navigator.msSaveBlob(i,r):void 0!==(a=document.createElement("a")).download&&(s=URL.createObjectURL(i),a.setAttribute("href",s),a.setAttribute("download",r),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)),this.showNotification("Table exported to JSON successfully!","success"),o}catch(e){return console.error("Error exporting to JSON:",e),this.showNotification("Error exporting to JSON: "+e.message,"danger"),null}}exportToPDF(e){try{var t=document.createElement("div"),a=(t.style.position="absolute",t.style.left="-9999px",t.style.top="-9999px",document.body.appendChild(t),document.createElement("table")),s=(a.style.width="100%",a.style.borderCollapse="collapse",document.createElement("thead"));const i=document.createElement("tr"),r=(e.headers.forEach(e=>{var t=document.createElement("th");t.textContent=e,t.style.backgroundColor="#f2f2f2",t.style.border="1px solid #ddd",t.style.padding="8px",t.style.fontWeight="bold",i.appendChild(t)}),s.appendChild(i),a.appendChild(s),document.createElement("tbody"));if(e.rows.forEach(e=>{const a=document.createElement("tr");e.forEach(e=>{var t=document.createElement("td");t.textContent=e,t.style.border="1px solid #ddd",t.style.padding="8px",a.appendChild(t)}),r.appendChild(a)}),a.appendChild(r),t.appendChild(a),"undefined"!=typeof html2pdf)html2pdf().from(a).save("table-export.pdf"),this.showNotification("Data exported to PDF successfully","success");else if("undefined"!=typeof jspdf&&"function"==typeof jspdf.jsPDF){var o=new jspdf.jsPDF;o.autoTable({html:a}),o.save("table-export.pdf"),this.showNotification("Data exported to PDF successfully","success")}else{const n=window.open("","_blank");n.document.write("<html><head><title>Export to PDF</title>"),n.document.write("<style>table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ddd; padding: 8px; } th { background-color: #f2f2f2; font-weight: bold; }</style>"),n.document.write("</head><body>"),n.document.write("<p>Please use your browser's print function to save as PDF.</p>"),n.document.write(a.outerHTML),n.document.write("</body></html>"),n.document.close(),setTimeout(()=>{n.print(),n.close()},250),this.showNotification("Please use print dialog to save as PDF","info")}document.body.removeChild(t)}catch(e){console.error("Error exporting to PDF:",e),this.showNotification("Error exporting to PDF. Check console for details.","error")}}exportToXML(o){try{let s='<?xml version="1.0" encoding="UTF-8"?>\n';s=s+"<table>\n"+"  <headers>\n",o.headers.forEach(e=>{e=e.replace(/[<>&'"]/g,e=>{switch(e){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&apos;";case'"':return"&quot;"}});s+=`    <header>${e}</header>
`}),s=s+"  </headers>\n"+"  <rows>\n",o.rows.forEach(e=>{s+="    <row>\n",e.forEach((e,t)=>{let a=o.headers[t]||"column"+(t+1);a=a.replace(/[^a-zA-Z0-9_]/g,"_").replace(/^[^a-zA-Z_]/,"_");t=String(e).replace(/[<>&'"]/g,e=>{switch(e){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&apos;";case'"':return"&quot;"}});s+=`      <${a}>${t}</${a}>
`}),s+="    </row>\n"}),s=s+"  </rows>\n"+"</table>";var e=new Blob([s],{type:"application/xml"}),t=URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download="table-export.xml",document.body.appendChild(a),a.click(),document.body.removeChild(a),this.showNotification("Data exported to XML successfully","success")}catch(e){console.error("Error exporting to XML:",e),this.showNotification("Error exporting to XML. Check console for details.","error")}}exportToHTML(e){try{let t=`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Export</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
        }
        .export-info {
            color: #666;
            font-size: 12px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Exported Table</h1>
    <p class="export-info">Exported on ${(new Date).toLocaleString()}</p>
    <table>
        <thead>
            <tr>
`;e.headers.forEach(e=>{t+=`                <th>${this.escapeHTML(e)}</th>
`}),t+=`            </tr>
        </thead>
        <tbody>
`,e.rows.forEach(e=>{t+="            <tr>\n",e.forEach(e=>{t+=`                <td>${this.escapeHTML(e)}</td>
`}),t+="            </tr>\n"}),t+=`        </tbody>
    </table>
</body>
</html>`;var a=new Blob([t],{type:"text/html"}),s=URL.createObjectURL(a),o=document.createElement("a");o.href=s,o.download="table-export.html",document.body.appendChild(o),o.click(),document.body.removeChild(o),this.showNotification("Data exported to HTML successfully","success")}catch(e){console.error("Error exporting to HTML:",e),this.showNotification("Error exporting to HTML. Check console for details.","error")}}escapeHTML(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}clearHangingRequests(){return!(!this.isLoadingAjax||!this.abortController||(this.log("🚨 Clearing potentially hanging request"),this.abortController.abort(),this.abortController=null,this.isLoadingAjax=!1,this.hideLoading(),0))}checkAndClearHangingRequests(){return!!this.clearHangingRequests()&&(this.showNotification("Cleared a stuck request. Please try again.","warning"),!0)}printTable(){var e=this.getExportData(),t=5<e.headers.length;let a='<table class="st-print-table"><thead><tr>';e.headers.forEach(e=>{a+=`<th>${e}</th>`}),a+="</tr></thead><tbody>",e.rows.forEach(e=>{a+="<tr>",e.forEach(e=>{a+=`<td>${e}</td>`}),a+="</tr>"}),a+="</tbody><tfoot><tr>",e.headers.forEach(e=>{a+=`<th>${e}</th>`}),a+="</tr></tfoot></table>";const s=window.open("","_blank");s.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Print Table</title>
                <style>
                    @media print {
                        @page {
                            size: ${t?"landscape":"portrait"};
                            margin: 1cm;
                        }
                        body {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        /* Table header appears at bottom of each page */
                        .st-print-table tfoot {
                            display: table-footer-group;
                        }
                        
                        /* Ensure proper page breaks */
                        .st-print-table thead {
                            display: table-header-group;
                        }
                        .st-print-table tbody {
                            display: table-row-group;
                        }
                        .st-print-table tr {
                            page-break-inside: avoid;
                        }
                    }
                    
                    body {
                        font-family: Arial, sans-serif;
                    }
                    
                    h1 {
                        text-align: center;
                        font-size: 18px;
                        margin-bottom: 10px;
                    }
                    
                    .date {
                        text-align: center;
                        font-size: 12px;
                        margin-bottom: 20px;
                        color: #666;
                    }
                    
                    .st-print-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 20px;
                    }
                    
                    .st-print-table th {
                        padding: 4px 5px;
                        border-bottom: 2px solid #333;
                        text-align: left;
                        font-weight: bold;
                    }
                    
                    /* Style for the repeating header at bottom of page */
                    .st-print-table tfoot th {
                        padding: 4px 5px;
                        border-bottom: 0 !important;
                        border-top: 2px solid #333;
                        text-align: left;
                        font-weight: bold;
                    }
                    
                    .st-print-table td {
                        padding: 3px 5px;
                        border-top: 1px solid #ddd;
                    }
                    
                    .footer {
                        text-align: center;
                        font-size: 12px;
                        color: #666;
                    }
                </style>
            </head>
            <body>
                <h1>Table Export</h1>
                <div class="date">Generated on ${(new Date).toLocaleString()}</div>
                ${a}
                <div class="footer">${e.rows.length} records total</div>
            </body>
            </html>
        `),s.document.close(),s.onload=function(){s.focus(),s.print(),s.onfocus=function(){setTimeout(function(){s.close()},200)}}}async addRecord(e={},m={}){const{showNotifications:g=!0,title:t="Add New Record",submitButtonText:a="Add Record",cancelButtonText:s="Cancel"}=m,o={};this.options.data.columns.forEach(e=>{if(e.data&&"actions"!==e.data&&"id"!==e.data&&!1!==e.editable)switch(e.type){case"number":o[e.data]=e.min||0;break;case"boolean":o[e.data]=!1;break;case"date":o[e.data]=(new Date).toISOString().split("T")[0];break;case"select":e.options&&0<e.options.length?o[e.data]="object"==typeof e.options[0]?e.options[0].value:e.options[0]:o[e.data]="";break;default:o[e.data]=""}});var e={...o,...e},i=this.callHook("beforeAddRecord",e,m);if(!1===i)return this.log("Add operation aborted by beforeAddRecord hook"),!1;i=i||e;const f="st-add-record-modal-"+Date.now();var e=`
        <div class="modal fade" id="${f}" tabindex="-1" role="dialog" aria-labelledby="${f}-label" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="${f}-label">${t}</h5>
                        <button class="btn btn-system ms-auto" type="button" data-bs-dismiss="modal" aria-label="Close">
                            <svg class="sa-icon sa-icon-2x">
                                <use href="img/sprite.svg#x"></use>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="${f}-form">
                            ${this.generateEditFormFields(i)}
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${s}</button>
                        <button type="button" class="btn btn-primary" id="${f}-submit">${a}</button>
                    </div>
                </div>
            </div>
        </div>
        `,r=this.callHook("onAddModalCreated",e,i,m);document.body.insertAdjacentHTML("beforeend",r||e);const b=document.getElementById(f),y=new bootstrap.Modal(b);return this.callHook("onAddModalBeforeShow",b,i,m),y.show(),this.callHook("onAddModalAfterShow",b,i,m),new Promise((p,u)=>{document.getElementById(f+"-submit").addEventListener("click",async e=>{var t=document.getElementById(f+"-form");if(t.checkValidity()){var a,s,o={};for([a,s]of new FormData(t).entries())o[a]=s;var i=this.callHook("onAddDataCollected",o,m)||o,r=this.options.data.idField||"id";i[r]=i[r]||String(Date.now()),y.hide();try{if(!1===this.callHook("beforeAddRecordSave",i,m))this.log("Add save operation aborted by beforeAddRecordSave hook"),b.remove(),p(!1);else if(Array.isArray(this.options.data.source))this.options.data.source.push(i),this.updateTableData(this.options.data.source),this.searchQuery&&""!==this.searchQuery.trim()&&setTimeout(()=>this.handleSearch(this.searchQuery),50),g&&this.showNotification("Record added successfully","success"),this.callHook("afterAddRecord",i,!0),this.callHook("onAddRecordSuccess",i),b.addEventListener("hidden.bs.modal",()=>{b.remove()}),p(i);else{var n=this.options.data.source,l={method:"POST",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...this.options.data.headers},body:JSON.stringify(i)},d=this.callHook("onAddRequestOptions",l,i,m)||l,c=await fetch(n,d);if(!c.ok)throw new Error("HTTP error! Status: "+c.status);var h=await c.json();if(h.error)throw new Error(h.error||"Failed to add record");this.clearAjaxCache(),this.loadAjax(),g&&this.showNotification("Record added successfully","success"),this.callHook("afterAddRecord",h.data||i,!0),this.callHook("onAddRecordSuccess",h.data||i),b.addEventListener("hidden.bs.modal",()=>{b.remove()}),p(h.data||i)}}catch(e){g&&this.showNotification("Failed to add record: "+e.message,"danger"),this.callHook("afterAddRecord",i,!1),this.callHook("onAddRecordError",e,i),b.addEventListener("hidden.bs.modal",()=>{b.remove()}),u(e)}}else e.preventDefault(),e.stopPropagation(),t.classList.add("was-validated"),this.showNotification("Please fill all required fields correctly","danger")}),b.addEventListener("hidden.bs.modal",()=>{b.parentNode&&(b.remove(),this.callHook("onAddCancelled",m),p(!1))})})}}export{SmartTables};