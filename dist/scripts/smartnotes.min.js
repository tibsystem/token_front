var NotesApp={currentNoteId:null,autoSaveTimeout:null,activeFormatting:{bold:!1,italic:!1,underline:!1},init:function(){this.renderNotesList(),this.setupAutoSave(),this.setupKeyboardShortcuts(),this.setupEditorEvents()},setupAutoSave:function(){var t=this;document.getElementById("note-content").addEventListener("input",function(){t.scheduleAutoSave(),t.updateNoteTitle()})},setupEditorEvents:function(){var e=this,i=document.getElementById("note-content");i.addEventListener("keyup",function(t){e.checkActiveFormatting(),"Enter"===t.key&&e.normalizeNewParagraph()}),i.addEventListener("click",function(){e.checkActiveFormatting()}),i.addEventListener("input",function(t){var e,n,o;1===i.childNodes.length&&i.firstChild.nodeType===Node.TEXT_NODE&&((e=document.createElement("h3")).style.fontWeight="bold",e.style.fontSize="1.2em",e.style.marginBottom="0.5em",e.appendChild(i.firstChild),i.appendChild(e),n=document.createRange(),o=window.getSelection(),n.setStart(e.firstChild,e.firstChild.textContent.length),n.collapse(!0),o.removeAllRanges(),o.addRange(n))})},checkActiveFormatting:function(){try{var t,e=window.getSelection();0<e.rangeCount&&(t=e.getRangeAt(0).commonAncestorContainer,this.activeFormatting.bold=this.hasParentWithStyle(t,"fontWeight","bold")||this.hasParentWithTag(t,"B")||this.hasParentWithTag(t,"STRONG"),this.activeFormatting.italic=this.hasParentWithStyle(t,"fontStyle","italic")||this.hasParentWithTag(t,"I")||this.hasParentWithTag(t,"EM"),this.activeFormatting.underline=this.hasParentWithStyle(t,"textDecoration","underline")||this.hasParentWithTag(t,"U"))}catch(t){console.warn("Selection-based formatting detection failed:",t),this.activeFormatting.bold=!1,this.activeFormatting.italic=!1,this.activeFormatting.underline=!1;try{var n,o=document.getElementById("note-content");o&&(n=document.getSelection().focusNode||o,this.activeFormatting.bold=this.isNodeFormatted(n,"bold"),this.activeFormatting.italic=this.isNodeFormatted(n,"italic"),this.activeFormatting.underline=this.isNodeFormatted(n,"underline"))}catch(t){console.error("Fallback formatting detection failed:",t)}}this.updateFormattingButtons()},isNodeFormatted:function(t,e){if(!t||t.nodeType!==Node.ELEMENT_NODE)return!(!t||!t.parentNode)&&this.isNodeFormatted(t.parentNode,e);var n=t;switch(e){case"bold":return"B"===n.tagName||"STRONG"===n.tagName||"bold"===window.getComputedStyle(n).fontWeight||700<=parseInt(window.getComputedStyle(n).fontWeight);case"italic":return"I"===n.tagName||"EM"===n.tagName||"italic"===window.getComputedStyle(n).fontStyle;case"underline":return"U"===n.tagName||window.getComputedStyle(n).textDecoration.includes("underline");default:return!1}},hasParentWithStyle(t,e,n){for(;t&&1===t.nodeType;){var o=window.getComputedStyle(t);if(o[e]===n||"textDecoration"===e&&o[e].includes(n))return!0;t=t.parentNode}return!1},hasParentWithTag(t,e){for(;t&&1===t.nodeType;){if(t.tagName===e)return!0;t=t.parentNode}return!1},updateFormattingButtons:function(){document.querySelectorAll(".formatting-btn").forEach(t=>{var e=t.getAttribute("data-format");this.activeFormatting[e]?t.classList.add("active"):t.classList.remove("active")})},setupKeyboardShortcuts:function(){document.addEventListener("keydown",function(t){if(NotesApp.currentNoteId&&t.ctrlKey)switch(t.key.toLowerCase()){case"b":t.preventDefault(),NotesApp.formatText("bold");break;case"i":t.preventDefault(),NotesApp.formatText("italic");break;case"u":t.preventDefault(),NotesApp.formatText("underline")}})},scheduleAutoSave:function(){var t=this;clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=setTimeout(function(){t.saveCurrentNote()},500)},getAllNotes:function(){try{var t=localStorage.getItem("notes");return t?JSON.parse(t):{}}catch(t){return console.error("Error reading notes from localStorage:",t),{}}},sanitizeHtml:function(t){if("undefined"!=typeof DOMPurify)return DOMPurify.sanitize(t,{ALLOWED_TAGS:["b","i","u","strong","em","h6","p","br","div","span"],ALLOWED_ATTR:["style"]});console.warn("DOMPurify not loaded. Using basic sanitization fallback.");var e=document.createElement("div");e.innerHTML=t;e.querySelectorAll("script, iframe, object, embed, form, input, button, textarea, style, link, meta").forEach(t=>t.remove());var n=e.querySelectorAll("*");for(let t=0;t<n.length;t++){var o=n[t],i=o.attributes;for(let t=i.length-1;0<=t;t--){var r=i[t],a=r.name.toLowerCase();"style"===a||!a.startsWith("on")&&"href"!==a&&"src"!==a&&"srcset"!==a&&"data"!==a||o.removeAttribute(r.name)}}return e.innerHTML},extractTitle:function(t){if(!t)return"Untitled Note";try{var e,n,o=document.createElement("div"),i=(o.innerHTML=t,o.querySelector("h1, h2, h3, h4, h5, h6, p, div"));return i?(e=i.textContent.trim()).substring(0,50)+(50<e.length?"...":""):(n=o.textContent.split("\n")[0]||"Untitled Note").substring(0,50)+(50<n.length?"...":"")}catch(t){return console.error("Error extracting title:",t),"Untitled Note"}},updateNoteTitle:function(){var t,e;this.currentNoteId&&(t=document.getElementById("note-content").innerHTML,t=this.extractTitle(t),(e=this.getAllNotes())[this.currentNoteId])&&(e[this.currentNoteId].title=t,localStorage.setItem("notes",JSON.stringify(e)),this.renderNotesList())},saveNote:function(t,e){if(!t)return console.error("Cannot save note: Missing note ID"),!1;if(!this.cleanContent(e))return!1;try{var n=this.getAllNotes(),o=this.sanitizeHtml(e);return n[t]={id:t,title:this.extractTitle(o),content:o,lastModified:(new Date).toISOString()},localStorage.setItem("notes",JSON.stringify(n)),!0}catch(t){return console.error("Error saving note:",t),!1}},cleanContent:function(t){var e=document.createElement("div"),e=(e.innerHTML=t,e.textContent.trim());return 0<e.length?t:""},deleteNote:function(t){var e;confirm("Are you sure you want to delete this note?")&&(delete(e=this.getAllNotes())[t],localStorage.setItem("notes",JSON.stringify(e)),this.renderNotesList())},clearAllNotes:function(){confirm("Are you sure you want to delete ALL notes? This cannot be undone.")&&(localStorage.removeItem("notes"),this.renderNotesList())},createNewNote:function(){var t="note_"+(new Date).getTime(),e=(this.currentNoteId=t,this.getAllNotes());e[t]={id:t,title:"Untitled Note",content:"",lastModified:(new Date).toISOString()},localStorage.setItem("notes",JSON.stringify(e)),this.showNoteEditor(t)},showNoteEditor:function(t){var e=this.getAllNotes()[t];e?(document.getElementById("note-content").innerHTML=e.content,document.getElementById("notes-list-view").style.display="none",document.getElementById("note-edit-view").style.display="block",this.currentNoteId=t,document.getElementById("note-content").focus(),this.ensureFirstLineIsHeading(),this.checkActiveFormatting()):console.error("Note not found:",t)},showNotesList:function(){document.getElementById("notes-list-view").style.display="block",document.getElementById("note-edit-view").style.display="none",this.currentNoteId=null,this.renderNotesList()},saveCurrentNote:function(){var t;this.currentNoteId&&(t=document.getElementById("note-content").innerHTML,this.getAllNotes()[this.currentNoteId]?this.saveNote(this.currentNoteId,t)&&this.renderNotesList():console.error("Cannot save note: Note ID not found in storage",this.currentNoteId))},formatText:function(e){try{var n=document.getElementById("note-content"),o=window.getSelection();if(0===o.rangeCount)n.focus();else{var i,r=o.getRangeAt(0);if(r.collapsed)n.focus();else{let t;switch(e){case"bold":t=document.createElement("strong");break;case"italic":t=document.createElement("em");break;case"underline":t=document.createElement("u");break;default:return console.warn(`Format '${e}' is not directly supported`),n.focus(),this.scheduleAutoSave(),void this.checkActiveFormatting()}this.activeFormatting[e]?this.removeFormatting(o,e):(a=r.extractContents(),t.appendChild(a),r.insertNode(t),o.removeAllRanges(),(i=document.createRange()).selectNodeContents(t),o.addRange(i)),n.focus(),this.scheduleAutoSave(),this.checkActiveFormatting()}}}catch(t){console.warn("Modern formatting failed:",t);var a=document.getElementById("note-content");const s=document.createElement("div");s.textContent="Formatting could not be applied at this time.",s.style.cssText="position:absolute; top:10px; right:10px; background:#fff3cd; color:#856404; padding:10px; border-radius:5px; z-index:1000;",document.body.appendChild(s),setTimeout(()=>{document.body.removeChild(s)},3e3),a.focus(),this.scheduleAutoSave(),this.checkActiveFormatting()}},removeFormatting:function(t,o){if(0!==t.rangeCount){var e=t.getRangeAt(0);let n=[];const r=e=>{if(e){let t=!1;switch(o){case"bold":t="STRONG"===e.nodeName||"B"===e.nodeName;break;case"italic":t="EM"===e.nodeName||"I"===e.nodeName;break;case"underline":t="U"===e.nodeName}t?n.push(e):e.hasChildNodes()&&Array.from(e.childNodes).forEach(t=>r(t))}};if(r(e.commonAncestorContainer),0===n.length){var i=e.cloneContents();if(r(i),0<n.length)return i=e.toString(),e.deleteContents(),e.insertNode(document.createTextNode(i)),t.removeAllRanges(),void t.addRange(e)}n.forEach(t=>{if(t.parentNode){for(;t.firstChild;)t.parentNode.insertBefore(t.firstChild,t);t.parentNode.removeChild(t)}})}},renderNotesList:function(){var t,n,o,i,r,a=this.getAllNotes(),e=document.getElementById("notes-container");0===Object.keys(a).length?e.innerHTML='<p class="text-center text-muted mt-4">No notes yet. Create one by clicking the <u>New Note</u> button!</p>':(t=Object.keys(a).sort(function(t,e){return new Date(a[e].lastModified)-new Date(a[t].lastModified)}),n={},o=new Date,o.setHours(0,0,0,0),i=new Date(o),i.setDate(i.getDate()-1),t.forEach(function(t){var t=a[t],e=new Date(t.lastModified);e.setHours(0,0,0,0),e=e.getTime()===o.getTime()?"Today":e.getTime()===i.getTime()?"Yesterday":e.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),n[e]||(n[e]=[]),n[e].push(t)}),r="",Object.keys(n).forEach(function(t){r+=`<h6 class="mt-2 mb-3">${t}</h6>`,n[t].forEach(function(t){var e=document.createElement("div"),n=(e.innerHTML=t.content,""),o="",i=e.querySelector("h1, h2, h3, h4, h5, h6, p, div");i?(n=i.textContent.trim(),i.remove(),o=e.textContent.trim()):n=t.title||"Untitled Note";i=(i=o.substring(0,100)+(100<o.length?"...":""))||'<span class="text-muted fst-italic">No additional content</span>';r+=`
                    <div class="info-container p-3 mb-2 note-item position-relative rounded">
                        <div class="d-flex w-100" onclick="NotesApp.showNoteEditor('${t.id}')">
                            <div class="w-100">
                                <h6 class="mb-1 text-break">${n}</h6>
                                <p class="mb-0 text-muted preview-text fs-sm text-break">${i}</p>
                            </div>
                        </div>
                        <button class="btn btn-outline-danger btn-xs position-absolute end-0 top-0 m-2 rounded-pill shadow-0" 
                            onclick="event.stopPropagation(); NotesApp.deleteNote('${t.id}')">
                            <i class="fal fa-trash"></i>
                        </button>
                    </div>`})}),e.innerHTML=r)},normalizeNewParagraph:function(){document.getElementById("note-content");var e=window.getSelection();if(e.rangeCount){let t=e.getRangeAt(0).startContainer;for(;t&&t.nodeType!==Node.ELEMENT_NODE;)t=t.parentNode;if(t&&t.previousElementSibling&&(t.style.fontWeight="normal",t.style.fontSize="1em",t.tagName.match(/^H[1-6]$/))){for(var n=document.createElement("p");t.firstChild;)n.appendChild(t.firstChild);t.parentNode.replaceChild(n,t);var o=document.createRange();o.setStart(n.firstChild||n,0),o.collapse(!0),e.removeAllRanges(),e.addRange(o)}}},ensureFirstLineIsHeading:function(){var t=document.getElementById("note-content");if(t.innerHTML.trim()){var e=t.querySelector("*");if(e){if(!["H1","H2","H3","H4","H5","H6"].includes(e.tagName)){var n=document.createElement("h3");for(n.style.fontWeight="bold",n.style.fontSize="1.2em",n.style.marginBottom="0.5em";e.firstChild;)n.appendChild(e.firstChild);e.parentNode.replaceChild(n,e)}let t=e.nextElementSibling;for(;t;)["H1","H2","H3","H4","H5","H6"].includes(t.tagName)||(t.style.fontWeight="normal",t.style.fontSize="1em"),t=t.nextElementSibling}}}};function createNewNote(){NotesApp.createNewNote()}function showNotesList(){NotesApp.showNotesList()}function formatText(t){NotesApp.formatText(t)}function clearAllNotes(){NotesApp.clearAllNotes()}window.onload=function(){NotesApp.init()};